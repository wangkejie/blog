<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msvalidate.01" content="9BDlx6FiNE">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wangkejie.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="书山有路勤为径，学海无涯苦作舟！">
<meta property="og:type" content="website">
<meta property="og:title" content="王科杰">
<meta property="og:url" content="https://wangkejie.com/index.html">
<meta property="og:site_name" content="王科杰">
<meta property="og:description" content="书山有路勤为径，学海无涯苦作舟！">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jack Wang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wangkejie.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>王科杰 - Jack's Notes</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?93e26277de0cf2c5851167f2c6dcaa7d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">王科杰</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Jack's Notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档<span class="badge">71</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/me/" rel="section"><i class="user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签<span class="badge">78</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>分类<span class="badge">70</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL29yZ3Mvd2FuZ2tlamllL3JlcG9zaXRvcmllcw==" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/home.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
              <span class="post-sticky-flag" title="置顶">
                <i class="fa fa-thumbtack"></i>
              </span>
            <a href="/home.html" class="post-title-link" itemprop="url">我的博客首页</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2015-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-16T00:00:00+08:00">2015-10-16</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/home.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/home.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <!-- 标签别名 -->
<!-- <center>【置顶】</center> -->
<!-- hext-next文档 -->
<!-- https://theme-next.js.org/docs/advanced-settings/front-matter.html?highlight=hexo+generator+index -->

<h1 id="欢迎来到我的博客"><a href="#欢迎来到我的博客" class="headerlink" title="欢迎来到我的博客"></a>欢迎来到我的博客</h1><blockquote>
<p>学习一些东西，记录一些东西。 这里是目录索引。 左侧边栏有<code>搜索</code>框，可以关键字检索整个博客内容。</p>
</blockquote>
<h2 id="记录-索引"><a href="#记录-索引" class="headerlink" title="记录/索引"></a>记录/索引</h2><ul>
<li><a href="./iOS/performance/modularization.html">组件化记录-未完</a></li>
<li><a href="./sumup/sumupthepast.html">总结过去-未完</a></li>
<li><a href="./acrossplatform/breakpad">Breakpad跨平台Crash Report解决方案</a></li>
<li><a href="./os/dyld">dyly-简阅</a></li>
<li><a href="./luafile/lua-patch">OC热修复方案 - 草稿中</a></li>
<li><a href="./luafile/luacode">lua源码学习</a></li>
<li><a href="./iOS/fishhook">fishhook crash</a></li>
<li><a href="./computer/string">字符串匹配算法</a></li>
<li><a href="./iOS/performance/wildpoint">野指针-未完</a></li>
<li><a href="">oom-卡顿等-未开始</a></li>
</ul>
<h2 id="不忘初心"><a href="#不忘初心" class="headerlink" title="不忘初心"></a>不忘初心</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvYXJjaGl2ZS9uYXZpZ2F0aW9uLw==">Apple官方文档<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9oaXQtYWxpYmFiYS5naXRodWIuaW8vaW50ZXJ2aWV3L2Jhc2ljL25ldHdvcmsvVENQLmh0bWw=">计算机知识点<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veGlhb2xpbmNvZGluZy9wLzEzNjMxMjI0Lmh0bWw=">计算机调度算法<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zd2lmdC5nZy8=">Swift 翻译组<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zd2lmdC5vcmcvc291cmNlLWNvZGUv">Swift source code<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscw==">苹果源码库<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h2 id="以后慢慢积累补充"><a href="#以后慢慢积累补充" class="headerlink" title="以后慢慢积累补充"></a>以后慢慢积累补充</h2><ul>
<li><a href="./iOS/crashrepaort/crashanalysis.html">iOS程序崩溃和抓取原理</a></li>
<li><a href="./python/index.html">Python</a> 未完待续，后期慢慢补上<ul>
<li>学习来源github 共勉之！(<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phY2tmcnVlZC9QeXRob24tMTAwLURheXM=">https://github.com/jackfrued/Python-100-Days<i class="fa fa-external-link-alt"></i></span>)</li>
<li>微软出了一个《Develop With Python on Windows》<br>  (<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vd2luZG93cy9weXRob24vZ2V0LXN0YXJ0ZWQvcHl0aG9uLWZvci1lZHVjYXRpb24=">https://docs.microsoft.com/zh-cn/windows/python/get-started/python-for-education<i class="fa fa-external-link-alt"></i></span>)</li>
</ul>
</li>
<li><a href="./vue/qa.html">Vue</a></li>
<li><a href="./linux/home.html">Linux相关知识点</a></li>
<li><a href="./luafile/">Lua相关</a></li>
<li>Swift</li>
<li>Flutter</li>
</ul>
<h2 id="关于iOS基础技术部分"><a href="#关于iOS基础技术部分" class="headerlink" title="关于iOS基础技术部分"></a>关于iOS基础技术部分</h2><ul>
<li>你可以点击<a href="./categories/">iOS目录</a>，查看更详细的大纲<ul>
<li><a href="./iOS/objective-c/index.html">OC相关基础</a></li>
<li><a href="./iOS/multithreading/index.html">多线程</a></li>
<li><a href="./iOS/RunTime/index.html">RunTime</a></li>
<li><a href="./iOS/RunLoop/index.html">RunLoop</a></li>
<li><a href="./iOS/Autoreleasepool.html">AutoReleasePool</a></li>
<li><a href="./iOS/block/index.html">block相关</a></li>
<li><a href="./iOS/animation/index.html">animation动画</a></li>
<li><a href="./iOS/algorithm/index.html">算法收集</a></li>
<li><a href="./iOS/memorymanagerment/memory.html">内存管理</a></li>
<li><a href="./iOS/performance/index.html">iOS优化</a></li>
<li><a href="./iOS/kernelarchitecture/overview.html">苹果内核架构</a></li>
<li><a href="./iOS/kernelarchitecture/mach.html">mach内核</a></li>
<li><a href="./iOS/thirdpart/asdk.html">AsyncDisplayKit</a></li>
<li><a href="./iOS/hybrid/hybrid.html">Hybrid浅谈</a></li>
</ul>
</li>
<li><a href="./iOS/study.html">面试快餐</a></li>
<li><a href="./categories/iOS/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">iOS源码学习</a><ul>
<li><a href="./iOS/origincode/metaclass.html">什么是元类</a></li>
<li><a href="./iOS/origincode/origincodestudy.html">类的本质</a></li>
<li><a href="./iOS/origincode/category.html">分类</a></li>
</ul>
</li>
<li><a href="./categories/iOS/Third-Party-Lib/">第三方库学习</a><ul>
<li><a href="./iOS/thirdpart/sdwebimage.html">SDWebImage</a></li>
<li><a href="iOS/thirdpart/glide.html">Glide</a></li>
</ul>
</li>
<li><a href="./categories/OS/">操作系统</a><ul>
<li><a href="os/ios-macos.html">MacOS和iOS操作系统</a></li>
</ul>
</li>
</ul>
<h2 id="快餐"><a href="#快餐" class="headerlink" title="快餐"></a>快餐</h2><ul>
<li><a href="./iOS/interview/">部分索引</a></li>
<li><a href="./iOS/interview/memory">内存管理</a></li>
<li><a href="./iOS/interview/xingneng">性能优化</a></li>
<li><a href="">待填补</a></li>
</ul>
<h2 id="待处理的事情-计划"><a href="#待处理的事情-计划" class="headerlink" title="待处理的事情/计划"></a>待处理的事情/计划</h2><ol>
<li>项目总结、沉淀</li>
<li>把收集的书籍列出来，标记已读和未读，已读的写读后感，未读的写推荐原因</li>
<li>规划5年/10年/未来（参考下面规划）</li>
</ol>
<h2 id="规划"><a href="#规划" class="headerlink" title="规划"></a>规划</h2><p>思考了一下，职场上，需要高调做事儿，私下还要低调做人。维护不好职场上的人际关系，也是不好有出路的。由于个人偏内向性格，喜欢钻研一些未知的东西，在以后的发展道路上，可能更适合往技术方向发展。 那么问题来了，年龄的增长一定会削弱钻研的buff，伴随着也会出现瓶颈，所以，势必得规划好转型。</p>
<p>技术方向，终归是个打工仔，技术再牛，也可能只是保住有个工作。</p>
<ul>
<li>技术深造。深度挖掘某个领域，如有创新更好。难~</li>
<li>技术转型。人工智能、web3等。只是多个就业路子~</li>
</ul>
<p>其他方向</p>
<ul>
<li>管理。主要看机遇，需要多表现这方面的倾向，多展露这方面的才能。</li>
<li>创业。倾家荡产。</li>
<li>老师/培训。半创业。</li>
</ul>
<h2 id="其它博客"><a href="#其它博客" class="headerlink" title="其它博客"></a>其它博客</h2><ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmliaXJlbWUuY29tLw==">YY<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cDovL2Jsb2cuc3Vubnl4eC5jb20v">孙源sunny<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmRldnRhbmcuY29tLw==">唐巧<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9taW5nMTAxNi5naXRodWIuaW8v">戴铭<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9vbmV2Y2F0LmNvbS8=">王巍<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9zYXRhbndvby5naXRodWIuaW8vMjAxNy8xMC8xOC9hYm9ydC8=">SatanWoo<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC82OTNlYzk2MmIzZDM=">GCD看这一篇就够了<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<h2 id="我的公众号"><a href="#我的公众号" class="headerlink" title="我的公众号"></a>我的公众号</h2><img src="/images/wechatpublic.jpg" class="" title="我的公众号">





<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9lM2Q1MjFiMmNiNDM=">需要反复阅读文章及子文章<i class="fa fa-external-link-alt"></i></span></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/home.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/post.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/post.html" class="post-title-link" itemprop="url">post</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-14 16:26:07" itemprop="dateCreated datePublished" datetime="2023-01-14T16:26:07+08:00">2023-01-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/post.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/post.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/future/index.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/future/index.html" class="post-title-link" itemprop="url">post</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-14 11:36:24" itemprop="dateCreated datePublished" datetime="2023-01-14T11:36:24+08:00">2023-01-14</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/future/index.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/future/index.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/luafile/luacode.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/luafile/luacode.html" class="post-title-link" itemprop="url">Lua源码学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-19 00:00:00" itemprop="dateCreated datePublished" datetime="2022-04-19T00:00:00+08:00">2022-04-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/luafile/luacode.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/luafile/luacode.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="lua虚拟机"><a href="#lua虚拟机" class="headerlink" title="lua虚拟机"></a>lua虚拟机</h1><h2 id="阅读源代码的次序"><a href="#阅读源代码的次序" class="headerlink" title="阅读源代码的次序"></a>阅读源代码的次序</h2><p>首先、阅读外围的库是如何实现功能扩展的，<br>然后、阅读 Lua 的具体实现。<br>之后、可以开始了解 Lua VM 的实现。<br>接下来就是分别理解函数调用、返回，string，metatable，table实现<br>debug模块是一个额外的设施、<br>最后是parse 等等编译相关的部分。<br>垃圾收集将是最难的部分，可能会花掉最多的时间去理解细节。<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNvZGluZ25vdy5jb20vMjAxMS8wNC9sdWFfZ2NfbXVsdGl0aHJlYWRpbmcuaHRtbA==">Lua GC 的源码剖析<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="虚拟机核心功能"><a href="#虚拟机核心功能" class="headerlink" title="虚拟机核心功能"></a>虚拟机核心功能</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>lua.c</td>
<td>可执行main函数入口</td>
</tr>
<tr>
<td>lapi.c</td>
<td>C语言接口</td>
</tr>
<tr>
<td>ldebug.c</td>
<td>Debug接口</td>
</tr>
<tr>
<td>ldo.c</td>
<td>函数调用、栈管理</td>
</tr>
<tr>
<td>lfunc.c</td>
<td>函数原型及闭包管理</td>
</tr>
<tr>
<td>lgc.c</td>
<td>垃圾回收机制</td>
</tr>
<tr>
<td>lmem.c</td>
<td>内存管理</td>
</tr>
<tr>
<td>lobject.c</td>
<td>对象操作函数</td>
</tr>
<tr>
<td>lopcodes.c</td>
<td>虚拟机字节码定义</td>
</tr>
<tr>
<td>lstate.c</td>
<td>全局状态机  管理全局信息</td>
</tr>
<tr>
<td>lstring.c</td>
<td>字符串池</td>
</tr>
<tr>
<td>ltable.c</td>
<td>表类型的相关操作</td>
</tr>
<tr>
<td>ltm.c</td>
<td>元方法</td>
</tr>
<tr>
<td>lvm.c</td>
<td>虚拟机</td>
</tr>
<tr>
<td>lzio.c</td>
<td>输入流接口</td>
</tr>
</tbody></table>
<h2 id="源代码解析和预编译"><a href="#源代码解析和预编译" class="headerlink" title="源代码解析和预编译"></a>源代码解析和预编译</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>lcode.c</td>
<td>代码生成器</td>
</tr>
<tr>
<td>ldump.c</td>
<td>序列化预编译的Lua字节码</td>
</tr>
<tr>
<td>llex.c</td>
<td>词法分析器</td>
</tr>
<tr>
<td>lparse.c</td>
<td>解析器</td>
</tr>
<tr>
<td>lundump.c</td>
<td>还原预编译的字节码</td>
</tr>
</tbody></table>
<h2 id="内嵌库"><a href="#内嵌库" class="headerlink" title="内嵌库"></a>内嵌库</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>lauxlib.c</td>
<td>库编写用到的辅助函数库</td>
</tr>
<tr>
<td>lbaselib.c</td>
<td>基础库</td>
</tr>
<tr>
<td>ldblib.c</td>
<td>Debug库</td>
</tr>
<tr>
<td>linit.c</td>
<td>内嵌库的初始化</td>
</tr>
<tr>
<td>liolib.c</td>
<td>IO库</td>
</tr>
<tr>
<td>lmathlib.c</td>
<td>数学库</td>
</tr>
<tr>
<td>loadlib.c</td>
<td>动态扩展库管理</td>
</tr>
<tr>
<td>loslib.c</td>
<td>OS库</td>
</tr>
<tr>
<td>lstrlib.c</td>
<td>字符串库</td>
</tr>
<tr>
<td>ltablib.c</td>
<td>表处理库</td>
</tr>
</tbody></table>
<h2 id="外部符号的前缀指示其来自的模块："><a href="#外部符号的前缀指示其来自的模块：" class="headerlink" title="外部符号的前缀指示其来自的模块："></a>外部符号的前缀指示其来自的模块：</h2><p>luaA_-lapi.c<br>luaB_-lbaselib.c<br>luaC_-lgc.c 垃圾回收部分<br>luaD_-ldo.c 函数的运行流程：函数调用及返回<br>luaE_-lstate.c 虚拟机的当前状态<br>luaF_-lfunc.c function实现<br>luaG_-ldebug.c<br>luaH_-ltable.c table实现<br>luaI_-lauxlib.c<br>luaK_-lcode.c<br>luaL_-lauxlib.c / h，linit.c（公共函数）<br>luaM_-lmem.c 内存管理<br>luaO_-lobject.c 不同的数据类型<br>luaP_-lopcodes.c 虚拟机的行为是由一组 opcode 控制的<br>luaS_-lstring.c string实现<br>luaT_-ltm.c 元表<br>luaU_-lundump.c<br>luaV_-lvm.c 虚拟机对 opcode 的解析和运作<br>luaX_-llex.c<br>luaY_-lparser.c<br>luaZ_-lzio.c 带缓冲的流处理<br>lua_-lapi.c / h + luaconf.h，debug.c<br>luai_-luaconf.h<br>luaopen_-luaconf.h +库（lbaselib.c，ldblib.c，liolib.c，lmathlib.c，<br>                                  loadlib.c，loslib.c，lstrlib.c，ltablib.c）</p>
<h2 id="结构体-类型"><a href="#结构体-类型" class="headerlink" title="结构体/类型"></a>结构体/类型</h2><p>Value结构体  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Union of all Lua values</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">Value</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">GCObject</span> *<span class="title">gc</span>;</span>    <span class="comment">/* collectable objects */</span></span><br><span class="line">  <span class="type">void</span> *p;         <span class="comment">/* light userdata */</span></span><br><span class="line">  lua_CFunction f; <span class="comment">/* light C functions */</span></span><br><span class="line">  lua_Integer i;   <span class="comment">/* integer numbers */</span></span><br><span class="line">  lua_Number n;    <span class="comment">/* float numbers */</span></span><br><span class="line">&#125; Value;</span><br></pre></td></tr></table></figure>

<p>TValue结构体 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Tagged Values. This is the basic representation of values in Lua:</span></span><br><span class="line"><span class="comment">** an actual value plus a tag with its type.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TValuefields	Value value_; lu_byte tt_</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TValue</span> &#123;</span></span><br><span class="line">  TValuefields;</span><br><span class="line">&#125; TValue;</span><br></pre></td></tr></table></figure>

<p>GCObject</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Common Header for all collectable objects (in macro form, to be</span></span><br><span class="line"><span class="comment">** included in other objects)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CommonHeader	GCObject *next; lu_byte tt; lu_byte marked</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Common type has only the common header</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">GCObject</span> &#123;</span></span><br><span class="line">  CommonHeader;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可回收的类型,都继承自GCObject</p>
<ul>
<li>TString</li>
<li>Udata</li>
<li>Proto</li>
<li>Closure</li>
<li>Table</li>
</ul>
<p>TString的定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Header for string value; string bytes follow the end of this structure</span></span><br><span class="line"><span class="comment">** (aligned according to &#x27;UTString&#x27;; see next).</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">TString</span> &#123;</span></span><br><span class="line">  CommonHeader;</span><br><span class="line">  lu_byte extra;  <span class="comment">/* reserved words for short strings; &quot;has hash&quot; for longs */</span></span><br><span class="line">  lu_byte shrlen;  <span class="comment">/* length for short strings */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> hash;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> lnglen;  <span class="comment">/* length for long strings */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">TString</span> *<span class="title">hnext</span>;</span>  <span class="comment">/* linked list for hash table */</span></span><br><span class="line">  &#125; u;</span><br><span class="line">&#125; TString;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Udata定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Header for userdata; memory area follows the end of this structure</span></span><br><span class="line"><span class="comment">** (aligned according to &#x27;UUdata&#x27;; see next).</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Udata</span> &#123;</span></span><br><span class="line">  CommonHeader;</span><br><span class="line">  lu_byte ttuv_;  <span class="comment">/* user value&#x27;s tag */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Table</span> *<span class="title">metatable</span>;</span></span><br><span class="line">  <span class="type">size_t</span> len;  <span class="comment">/* number of bytes */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">Value</span> <span class="title">user_</span>;</span>  <span class="comment">/* user value */</span></span><br><span class="line">&#125; Udata;</span><br></pre></td></tr></table></figure>

<p>Proto定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Function Prototypes</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Proto</span> &#123;</span></span><br><span class="line">  CommonHeader;</span><br><span class="line">  lu_byte numparams;  <span class="comment">/* number of fixed parameters */</span></span><br><span class="line">  lu_byte is_vararg;</span><br><span class="line">  lu_byte maxstacksize;  <span class="comment">/* number of registers needed by this function */</span></span><br><span class="line">  <span class="type">int</span> sizeupvalues;  <span class="comment">/* size of &#x27;upvalues&#x27; */</span></span><br><span class="line">  <span class="type">int</span> sizek;  <span class="comment">/* size of &#x27;k&#x27; */</span></span><br><span class="line">  <span class="type">int</span> sizecode;</span><br><span class="line">  <span class="type">int</span> sizelineinfo;</span><br><span class="line">  <span class="type">int</span> sizep;  <span class="comment">/* size of &#x27;p&#x27; */</span></span><br><span class="line">  <span class="type">int</span> sizelocvars;</span><br><span class="line">  <span class="type">int</span> linedefined;</span><br><span class="line">  <span class="type">int</span> lastlinedefined;</span><br><span class="line">  TValue *k;  <span class="comment">/* constants used by the function */</span></span><br><span class="line">  Instruction *code;  <span class="comment">/* opcodes */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Proto</span> **<span class="title">p</span>;</span>  <span class="comment">/* functions defined inside the function */</span></span><br><span class="line">  <span class="type">int</span> *lineinfo;  <span class="comment">/* map from opcodes to source lines (debug information) */</span></span><br><span class="line">  LocVar *locvars;  <span class="comment">/* information about local variables (debug information) */</span></span><br><span class="line">  Upvaldesc *upvalues;  <span class="comment">/* upvalue information */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">LClosure</span> *<span class="title">cache</span>;</span>  <span class="comment">/* last-created closure with this prototype */</span></span><br><span class="line">  TString  *source;  <span class="comment">/* used for debug information */</span></span><br><span class="line">  GCObject *gclist;</span><br><span class="line">&#125; Proto;</span><br></pre></td></tr></table></figure>

<p>Closure分为两种，Lua闭包和C闭包，定义如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** Closures</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ClosureHeader \</span></span><br><span class="line"><span class="meta">	CommonHeader; lu_byte nupvalues; GCObject *gclist</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CClosure</span> &#123;</span></span><br><span class="line">  ClosureHeader;</span><br><span class="line">  lua_CFunction f;</span><br><span class="line">  TValue upvalue[<span class="number">1</span>];  <span class="comment">/* list of upvalues */</span></span><br><span class="line">&#125; CClosure;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">LClosure</span> &#123;</span></span><br><span class="line">  ClosureHeader;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Proto</span> *<span class="title">p</span>;</span> <span class="comment">//lua函数的原型指针</span></span><br><span class="line">  UpVal *upvals[<span class="number">1</span>];  <span class="comment">/* list of upvalues */</span></span><br><span class="line">&#125; LClosure;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Table定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Table</span> &#123;</span></span><br><span class="line">  CommonHeader;</span><br><span class="line">  lu_byte flags;  <span class="comment">/* 1&lt;&lt;p means tagmethod(p) is not present */</span></span><br><span class="line">  lu_byte lsizenode;  <span class="comment">/* log2 of size of &#x27;node&#x27; array */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sizearray;  <span class="comment">/* size of &#x27;array&#x27; array */</span></span><br><span class="line">  TValue *<span class="built_in">array</span>;  <span class="comment">/* array part */</span></span><br><span class="line">  Node *node;</span><br><span class="line">  Node *lastfree;  <span class="comment">/* any free position is before this position */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">Table</span> *<span class="title">metatable</span>;</span></span><br><span class="line">  GCObject *gclist;</span><br><span class="line">&#125; Table;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从面向对象的角度分析的话，可以认为这5种内部基础类型，都继承自GCObject。<br>创建一个内部对象，使用同一个的接口函数<code>luaC_newobj (lua_State *L, int tt, size_t sz)</code> 参数说明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** create a new collectable object (with given type and size) and link</span></span><br><span class="line"><span class="comment">** it to &#x27;allgc&#x27; list.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">GCObject *<span class="title function_">luaC_newobj</span> <span class="params">(lua_State *L, <span class="type">int</span> tt, <span class="type">size_t</span> sz)</span> &#123;</span><br><span class="line">  global_State *g = G(L);</span><br><span class="line">  GCObject *o = cast(GCObject *, luaM_newobject(L, novariant(tt), sz));</span><br><span class="line">  o-&gt;marked = luaC_white(g); <span class="comment">//标记这个对象是white</span></span><br><span class="line">  o-&gt;tt = tt;  <span class="comment">//类型</span></span><br><span class="line">  o-&gt;next = g-&gt;allgc; <span class="comment">//新创建的对象放到gclist的最前面</span></span><br><span class="line">  g-&gt;allgc = o;</span><br><span class="line">  <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> luaM_newobject(L,tag,s)	luaM_realloc_(L, NULL, tag, (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">** generic allocation routine.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">luaM_realloc_</span> <span class="params">(lua_State *L, <span class="type">void</span> *block, <span class="type">size_t</span> osize, <span class="type">size_t</span> nsize)</span> &#123;</span><br><span class="line">  <span class="type">void</span> *newblock;</span><br><span class="line">  global_State *g = G(L);</span><br><span class="line">  <span class="type">size_t</span> realosize = (block) ? osize : <span class="number">0</span>; <span class="comment">//新建的话，block都是NULL</span></span><br><span class="line">  lua_assert((realosize == <span class="number">0</span>) == (block == <span class="literal">NULL</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(HARDMEMTESTS)</span></span><br><span class="line">  <span class="keyword">if</span> (nsize &gt; realosize &amp;&amp; g-&gt;gcrunning)</span><br><span class="line">    luaC_fullgc(L, <span class="number">1</span>);  <span class="comment">/* force a GC whenever possible */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  newblock = (*g-&gt;frealloc)(g-&gt;ud, block, osize, nsize);  <span class="comment">//调用的就是l_alloc</span></span><br><span class="line">  <span class="keyword">if</span> (newblock == <span class="literal">NULL</span> &amp;&amp; nsize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    lua_assert(nsize &gt; realosize);  <span class="comment">/* cannot fail when shrinking a block */</span></span><br><span class="line">    <span class="keyword">if</span> (g-&gt;version) &#123;  <span class="comment">/* is state fully built? */</span></span><br><span class="line">      luaC_fullgc(L, <span class="number">1</span>);  <span class="comment">/* try to free some memory... */</span></span><br><span class="line">      newblock = (*g-&gt;frealloc)(g-&gt;ud, block, osize, nsize);  <span class="comment">/* try again */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newblock == <span class="literal">NULL</span>)</span><br><span class="line">      luaD_throw(L, LUA_ERRMEM);</span><br><span class="line">  &#125;</span><br><span class="line">  lua_assert((nsize == <span class="number">0</span>) == (newblock == <span class="literal">NULL</span>));</span><br><span class="line">  g-&gt;GCdebt = (g-&gt;GCdebt + nsize) - realosize;</span><br><span class="line">  <span class="keyword">return</span> newblock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="GCObjcet类型"><a href="#GCObjcet类型" class="headerlink" title="GCObjcet类型"></a>GCObjcet类型</h2><p>通过统一的接口luaC_newobj函数，创建的内部对象都是GCObjcet类型。如果要正常使用，还需要做一次转换，LUA对于这种抽象结构转换为具体对象结构的行为，封装了一套宏函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* macros to convert a GCObject into a specific value */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2ts(o)  \</span></span><br><span class="line"><span class="meta">	check_exp(novariant((o)-&gt;tt) == LUA_TSTRING, &amp;((cast_u(o))-&gt;ts))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2u(o)  check_exp((o)-&gt;tt == LUA_TUSERDATA, &amp;((cast_u(o))-&gt;u))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2lcl(o)  check_exp((o)-&gt;tt == LUA_TLCL, &amp;((cast_u(o))-&gt;cl.l))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2ccl(o)  check_exp((o)-&gt;tt == LUA_TCCL, &amp;((cast_u(o))-&gt;cl.c))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2cl(o)  \</span></span><br><span class="line"><span class="meta">	check_exp(novariant((o)-&gt;tt) == LUA_TFUNCTION, &amp;((cast_u(o))-&gt;cl))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2t(o)  check_exp((o)-&gt;tt == LUA_TTABLE, &amp;((cast_u(o))-&gt;h))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2p(o)  check_exp((o)-&gt;tt == LUA_TPROTO, &amp;((cast_u(o))-&gt;p))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> gco2th(o)  check_exp((o)-&gt;tt == LUA_TTHREAD, &amp;((cast_u(o))-&gt;th))</span></span><br></pre></td></tr></table></figure>

<img src="/images/gcobject.jpg" class="" title="gcobject">


<h1 id="推荐一本书-lt-自己动手实现lua虚拟机-gt"><a href="#推荐一本书-lt-自己动手实现lua虚拟机-gt" class="headerlink" title="推荐一本书&lt;自己动手实现lua虚拟机&gt;"></a>推荐一本书&lt;自己动手实现lua虚拟机&gt;</h1><p>lundump文件</p>
<h2 id="字节流结构-二进制-chunk"><a href="#字节流结构-二进制-chunk" class="headerlink" title="字节流结构 二进制 chunk"></a>字节流结构 二进制 chunk</h2><h3 id="头部header"><a href="#头部header" class="headerlink" title="头部header"></a>头部header</h3><p>{<br>    签名，          “\x1bLua”   (0x1b4c7561)<br>    版本，          0x53<br>    格式(0x00)      0x00<br>    LUAC_DATA       0x1993 0d 0a<br>    cint            4<br>    sizet           8<br>    lua虚拟机指令     4<br>    lua_integer     8<br>    lua_number      8<br>    lua_int  0x5678（判断大小端）<br>    lua_num  370.5  (浮点数格式)</p>
<p>}</p>
<h3 id="函数原型"><a href="#函数原型" class="headerlink" title="函数原型"></a>函数原型</h3><ol>
<li>源文件名<br> 以@开头的是源码编译而来，以=开头的，是标准库而来</li>
<li>起止行号<br> 两个cint,主函数为0</li>
<li>固定参数个数</li>
<li>是否是Vararg函数</li>
<li>寄存器数量<br> MaxStackSize, 因为lua是一种栈结构,可以按索引访问，模拟寄存器</li>
<li>指令表</li>
<li>常量表</li>
<li>Upvalue表  {Instack,Idx}两个字节</li>
<li>子函数原型表</li>
<li>行号表. 和指令表中的指令一一对应</li>
<li>局部变量表<br>LocVar<br>{<pre><code>VarName  String
StartPC   Uint32
EndPC       Uint32
</code></pre>
}</li>
<li>Upvalue名列表</li>
</ol>
<blockquote>
<p>行号表、局部变量表、Upvalue名列表 都是调试信息</p>
</blockquote>
<h3 id="解析二进制-chunk"><a href="#解析二进制-chunk" class="headerlink" title="解析二进制 chunk"></a>解析二进制 chunk</h3><p>//头部header校验<br>lundump.h 里面看 checkHeader函数</p>
<p>//函数原型<br>LoadCode(S, f);<br>LoadConstants(S, f);<br>LoadUpvalues(S, f);<br>LoadProtos(S, f);<br>LoadDebug(S, f);</p>
<h2 id="指令集"><a href="#指令集" class="headerlink" title="指令集"></a>指令集</h2><p>lopcodes文件</p>
<ol>
<li>基于栈的虚拟机(Stack Based)<br> Java、.NET、CLR、Python、ruby、Yarv;<br> PUSH/POP操作栈，指令集大，平均长度短</li>
<li>基于寄存器(Resigter Based), lua_5.0以后<br> 需要把寄存器地址编码进指令，平均长度长</li>
</ol>
<p>lua采用定长指令集（大约47条指令）， 每条指令4字节32位，6位Opcode操作码，26位操作数Operand</p>
<h2 id="指令编码格式"><a href="#指令编码格式" class="headerlink" title="指令编码格式"></a>指令编码格式</h2><h3 id="编码模式"><a href="#编码模式" class="headerlink" title="编码模式"></a>编码模式</h3><p>按照高26位区分，四种mode， iABC、iABx、iAsBx、iAx<br>iABC可以携带ABC三个操作数8+9+9比特<br>iABx携带 A、Bx，8+18<br>iAx Ax，26<br>iAsBx As、Bx  8+18</p>
<h3 id="操作码"><a href="#操作码" class="headerlink" title="操作码"></a>操作码</h3><p>6位，最多64条指令，参看opcodes</p>
<h3 id="操作数"><a href="#操作数" class="headerlink" title="操作数"></a>操作数</h3><p>A主要用来表示目标寄存器索引，OpArgN、U、R、K</p>
<h3 id="指令表"><a href="#指令表" class="headerlink" title="指令表"></a>指令表</h3><p>LUAI_DDEF const lu_byte luaP_opmodes[NUM_OPCODES]</p>
<h3 id="指令解码"><a href="#指令解码" class="headerlink" title="指令解码"></a>指令解码</h3><p>CREATE_ABC、CREATE_ABx、CREATE_Ax<br>sBx是有符号整数，18位。 Excess-K编码模式，Offset Binary. x-K. K取最大无符号一半</p>
<h2 id="Lua-API"><a href="#Lua-API" class="headerlink" title="Lua API"></a>Lua API</h2><p>主要以Lua_开头的。60多个luaL_开头的辅助函数，付主函数建立在基础函数之上</p>
<h2 id="Lua栈"><a href="#Lua栈" class="headerlink" title="Lua栈"></a>Lua栈</h2><p>Lua栈是宿主语言和Lua语言沟通的桥梁，api基本上也都是操作这个所谓的栈结构lua_state</p>
<h3 id="Lua数据类型"><a href="#Lua数据类型" class="headerlink" title="Lua数据类型"></a>Lua数据类型</h3><p>8种， nil、boolean、number、string、table、function、thread、userdata</p>
<h2 id="虚拟机雏形-Lua运算符"><a href="#虚拟机雏形-Lua运算符" class="headerlink" title="虚拟机雏形 Lua运算符"></a>虚拟机雏形 Lua运算符</h2><p>程序计数器(Program Counter, 简称PC)记录正在执行的指令。</p>
<h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><p>lua表是一个关联数组, 包含哈希表和数组两个部分</p>
<h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h2><p>参数</p>
<ul>
<li>固定参数个数，未传递则nil，多传递则忽略</li>
<li>返回值，外部接受几个，多退少补nil的策略，作为函数参数，如数覆盖</li>
</ul>
<p>load,加载二进制chunk或者源码。把被调函数推入栈顶<br>call, </p>
<h2 id="交互-lua-lt-gt-其它语言"><a href="#交互-lua-lt-gt-其它语言" class="headerlink" title="交互 lua &lt;-&gt; 其它语言"></a>交互 lua &lt;-&gt; 其它语言</h2><p>lua注册表，lua_status里<br>lua全局环境 G， GlobalTable</p>
<h2 id="闭包和Upvalue"><a href="#闭包和Upvalue" class="headerlink" title="闭包和Upvalue"></a>闭包和Upvalue</h2><ol>
<li>一等函数，java不支持，可作为参数传递，返回等</li>
<li>变量作用域。 动态作用域、静态作用域</li>
<li>闭包。 词法作用域捕获了非局部变量的嵌套函数</li>
</ol>
<p>Upvalue是lua里面的术语，就是闭包内部捕获的非局部变量。<br>嵌套函数，捕获外围的外围的函数的变量，外围函数会捕获更外围的局部变量。扁平闭包。</p>
<p>_ENV — 全局环境 隐式的Upvalue</p>
<h2 id="元变成-Metaprogram"><a href="#元变成-Metaprogram" class="headerlink" title="元变成 Metaprogram"></a>元变成 Metaprogram</h2><p>值类型默认没有元表，元表nil。 字符串提供了默认元表。</p>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>迭代器模式.<br>数值for循环是借助FORPREP和FORLOOP两条指令完成<br>通用for循环，TFORCALL和TFORLOOP两条指令</p>
<h2 id="异常和错误处理"><a href="#异常和错误处理" class="headerlink" title="异常和错误处理"></a>异常和错误处理</h2><h2 id="Lua语法和编译器"><a href="#Lua语法和编译器" class="headerlink" title="Lua语法和编译器"></a>Lua语法和编译器</h2><ul>
<li>词法分析</li>
<li>抽象语法树</li>
<li>语法分析</li>
<li>代码生成</li>
</ul>
<h2 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h2><p>字符流(源码)，以’token’的形式分解<br>类型注释、关键字、标识符、字面量、运算符、分隔符等<br>lua会忽略 \n \r \t \v \f 空格等空白字符<br>忽略注释</p>
<p>token -&gt; { … ; : . }  .etc</p>
<h2 id="抽象语法树-AST"><a href="#抽象语法树-AST" class="headerlink" title="抽象语法树 AST"></a>抽象语法树 AST</h2><p>计算机编程语言一般使用上下文无关文法(Context-free Grammar, CFG)描述，而CFG一般使用巴科斯范式(Backus-Naur Form, BNF)或者其扩展EBNF(Extended BNF)书写</p>
<h2 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h2><p>YACC、Bison、ANTLR、JavaCC</p>
<h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><h2 id="辅助API和基础库"><a href="#辅助API和基础库" class="headerlink" title="辅助API和基础库"></a>辅助API和基础库</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/computer/string.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/computer/string.html" class="post-title-link" itemprop="url">字符串匹配算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-16 15:15:01" itemprop="dateCreated datePublished" datetime="2021-09-16T15:15:01+08:00">2021-09-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/%E5%AD%97%E7%AC%A6%E4%B8%B2/" itemprop="url" rel="index"><span itemprop="name">字符串</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/computer/string.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/computer/string.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基本分类："><a href="#基本分类：" class="headerlink" title="基本分类："></a>基本分类：</h2><ul>
<li><h4 id="1-朴素法：BF-Brute-Force"><a href="#1-朴素法：BF-Brute-Force" class="headerlink" title="1.朴素法：BF(Brute Force)"></a>1.朴素法：BF(Brute Force)</h4><p>  暴风(Brute Force)算法是普通的模式匹配算法，BF算法的思想就是将目标串S的第一个字符与模式串T的第一个字符进行匹配，若相等，则继续比较S的第二个字符和 T的第二个字符；若不相等，则比较S的第二个字符和T的第一个字符，依次比较下去，直到得出最后的匹配结果。    </p>
<ul>
<li><p><strong>思路</strong>  </p>
<p>  首先S[1]和T[1]比较，若相等，则再比较S[2]和T[2]，一直到T[M]为止；若S[1]和T[1]不等，则S向右移动一个字符的位置，再依次进行比较。如果存在k，1≤k≤N，且S[k+1…k+M]=T[1…M]，则匹配成功；否则失败。该算法最坏情况下要进行M*(N-M+1)次比较，时间复杂度为O(M*N)</p>
</li>
<li><p><strong>匹配过程</strong><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/24/1577174693577-bf.png" alt="image">  </p>
</li>
<li><p><strong>代码</strong><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577257833453-bf_code.png" alt="BF Code"></p>
</li>
</ul>
</li>
<li><h4 id="2-基于前后缀"><a href="#2-基于前后缀" class="headerlink" title="2.基于前后缀"></a>2.基于前后缀</h4><ul>
<li><p><strong>KMP</strong></p>
<ul>
<li><p><strong>思路</strong><br>  假设现在文本串S匹配到 i 位置，模式串P匹配到 j 位置。如果j = -1，或者当前字符匹配成功（即S[i] == P[j]），都令i++，j++，继续匹配下一个字符；如果j != -1，且当前字符匹配失败（即S[i] != P[j]），则令 i 不变，j = next[j]。此举意味着失配时，模式串P相对于文本串S向右移动了j - next [j] 位。换言之，当匹配失败时，模式串向右移动的位数为：失配字符所在位置 - 失配字符对应的next 值），即移动的实际位数为：j - next[j]，且此值大于等于1。</p>
<p>  next 数组各值的含义：代表当前字符==之前：不包括自身==的字符串中，有多大长度的相同前缀后缀。例如如果next [j] =k，代表j之前的字符串中有最大长度为k的相同前缀后缀。此也意味着在某个字符失配时，该字符对应的next值会告诉你下一步匹配中，模式串应该跳到哪个位置（跳到next [j] 的位置）。如果next [j] 等于0或-1，则跳到模式串的开头字符，若next [j] = k 且 k &gt; 0，代表下次匹配跳到j 之前的某个字符，==而不是跳到开头，且具体跳过了k 个字符，这就是KMP相对于BF的优化==。     </p>
</li>
<li><p><strong>最长前缀后缀表</strong><br>  对于P = p0 p1 …pj-1 pj，寻找模式串P中长度最大且相等的前缀和后缀。如果存在p0 p1 …pk-1 pk = pj- k pj-k+1…pj-1 pj，那么在包含pj的模式串中有最大长度为k+1的相同前缀后缀。比如求模式串“ABCDABD”的最长前缀后缀表过程：<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577260060952-kmp_longest_prefix" alt="kmp_longest_prefix_1">    </p>
<p>  所以最后求得的模式串“ABCDABD”的最长前缀后缀表为：<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577260060922-kmp_longest_prefix_1" alt="kmp_longest_prefix_2">      </p>
</li>
<li><p><strong>根据前缀后缀表推导next数组</strong><br>  next 数组考虑的是==除当前字符外==的最长相同前缀后缀，所以通过前面最长前缀后缀表求得各个前缀后缀的公共元素的最大长度后，只要稍作变形即可：将前面最长前缀后缀表中求得的值整体右移一位，然后初值赋为-1，如下表格所示：<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577260521069-kmp_longest_prefix_3" alt="kmp_longest_prefix_3">      </p>
</li>
<li><p><strong>如何求next数组</strong>        </p>
<ul>
<li>根据前面匹配的求后一个的next<br>  给定模式串ABCDABCE，且已知next [j] = k（相当于“p0 pk-1” = “pj-k pj-1” = AB，可以看出k为2），现要求next [j + 1]等于多少？因为pk = pj = C，所以next[j + 1] = next[j] + 1 = k + 1（可以看出next[j + 1] = 3）。代表字符E前的模式串中，有长度k+1 的相同前缀后缀。<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577274995335-next_2.png" alt="next_1">     但如果====pk== != pj== 呢？说明“p0 pk-1 pk”  ≠ “pj-k pj-1 pj”。换言之，当pk != pj后，字符E前有多大长度的相同前缀后缀呢？很明显，因为C不同于D，所以ABC 跟 ABD不相同，即字符E前的模式串没有长度为k+1的相同前缀后缀，也就不能再简单的令：next[j + 1] = next[j] + 1。所以，这个时候可以去找p[k]的前缀中有没有合适的前缀。见下图递归推导过程<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577275465434-next_3.png" alt="next_2">      </li>
<li>递归的推导过程<br>  k = next[k];<br>  待求的是p[j+1]，发现p[j] !=  p[k]，那就递归寻找p[next[k]]和p[j]是否一样，如果一样，那next[j+1] = next[next[k] + 1<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577275521268-kmp_next.png" alt="递归">      </li>
</ul>
</li>
<li><p><strong>求next数组代码</strong><br>  <a href="">见IDEA代码</a>      </p>
</li>
<li><p><strong>匹配过程</strong><br>  假设S=“ABCDAB ABCDABCDABDE”，P=“ABCDABD”    </p>
<ol>
<li>P[0]跟S[4]匹配成功，P[1]跟S[5]也匹配成功…，直到当匹配到P[6]处的字符D时失配（即S[10] != P[6]），由于P[6]处的D对应的next值为2，所以下一步用P[2]处的字符C继续跟S[10]匹配，相当于向右移动：j-next[j]=6-2=4位。<br><img src="https://s.momocdn.com/w/u/others/2019/12/25/1577259144804-kmp_1.png" alt="kmp_1"></li>
<li>向右移动4位后，P[2]处的C再次失配，由于C对应的next值为0，所以下一步用P[0]处的字符继续跟S[10]匹配，相当于向右移动：j - next[j] = 2 - 0 = 2 位。<br><img src="https://s.momocdn.com/w/u/others/2019/12/25/1577259144630-kmp_2.png" alt="kmp_2">   </li>
<li>移动两位之后，A 跟空格不匹配，模式串后移1 位。<br><img src="https://s.momocdn.com/w/u/others/2019/12/25/1577259144781-kmp_3.png" alt="kmp_3"></li>
<li>P[6]处的D再次失配，因为P[6]对应的next值为2，故下一步用P[2]继续跟文本串匹配，当于模式串向右移动 j - next[j] = 6 - 2 = 4 位。<br><img src="https://s.momocdn.com/w/u/others/2019/12/25/1577259144657-kmp_4.png" alt="kmp_4">   </li>
<li>匹配成功，过程结束。<br><img src="https://s.momocdn.com/w/u/others/2019/12/25/1577259144680-kmp_5.png" alt="kmp_5">   </li>
</ol>
</li>
<li><p><strong>kmp算法查找过程</strong><br>  <a href="">见IDEA代码</a></p>
</li>
<li><p><strong>next数组的优化</strong><br>  比如，求模式串“abab”的next 数组，可得其next 数组为-1 0 0 1，当它跟下图中的文本串去匹配的时候，发现b跟c失配，于是模式串右移j - next[j] = 3 - 1 =2位。<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577276557271-next_abab_1.jpg" alt="next_abab_1">    </p>
<p>  右移2位后，b又跟c失配。事实上，因为在上一步的匹配中，已经得知p[3] = b，与s[3] = c失配，而右移两位之后，让p[ next[3] ] = p[1] = b 再跟s[3]匹配时，必然失配。问题出在哪呢？<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/25/1577276557271-next_abab_2.jpg" alt="next_abab_2">        </p>
<p>  问题出在不该出现p[j] = p[ next[j] ]。为什么呢？理由是：当p[j] != s[i] 时，下次匹配必然是p[ next [j]] 跟s[i]匹配，如果p[j] = p[ next[j] ]，必然导致后一步匹配失败（因为p[j]已经跟s[i]失配，然后还用跟p[j]等同的值p[next[j]]去跟s[i]匹配，很显然，必然失配），所以不能允许p[j] = p[ next[j ]]。如果出现了p[j] = p[ next[j] ]咋办呢？如果出现了，则需要再次递归，即令next[j] = next[ next[j] ]<br>  <a href="">见IDEA代码</a></p>
</li>
<li><p><strong>时间复杂度</strong><br>  如果文本串的长度为n，模式串的长度为m，那么匹配过程的时间复杂度为O(n)，算上计算next的O(m)时间，KMP的整体时间复杂度为O(m + n)。    </p>
</li>
<li><p><strong>参考资料</strong>      </p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3ZfanVseV92L2FydGljbGUvZGV0YWlscy83MDQxODI3">July大神–从头到尾彻底理解KMP<i class="fa fa-external-link-alt"></i></span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3M/X19iaXo9TXpJMk9UUXhNVE00T1E9PSZtaWQ9MjI0NzQ4OTg2MCZpZHg9MiZzbj01ZGI0MjdhMTM0YTQ3YmNhZWQ2MjIwNGVhMDE5M2UwNSZjaGtzbT1lYWUxZWMxNmRkOTY2NTAwODZiZjA4MGU0MjI2NDI0YWU2MTg1NjViZWYzYmIwNmZkZGVmNWZiZGJjNWUwM2UwNDNlZjdlYzM1ZGFkJm1wc2hhcmU9MSZzY2VuZT0yNCZzcmNpZD0mc2hhcmVyX3NoYXJldGltZT0xNTY2NTIzODU5NDE0JnNoYXJlcl9zaGFyZWlkPWM2NTJmM2ZlMzhhYjZhMjkyYjg0ZjQ4YmFiMTk4ZDI0I3Jk">7分钟动画理解KMP<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>BM(Boyer-Moore)</strong><br>  Boyer-Moore算法平均要比KMP快3-5倍，grep，window电脑的查找还有各种文本查找都用的BM算法。它和之前的BF和KMP匹配的过程不大一样，采用的是从后往前对比的过程。BM算法实际上包含两个并行的算法（也就是两个启发策略）：坏字符算法（bad-character shift）和好后缀算法（good-suffix shift）。这两种算法的目的就是让模式串每次向右移动尽可能大的距离     </p>
<ul>
<li><strong>思路</strong><br>  从后往前匹配。如果遇到不一致的字符，则这个字符就是==坏的字符==，所以坏字符是针对匹配串S的；匹配的路上相同的字符以及子集称为==好的后缀==，所以好的字符是针对模式串P的。每次失配时，都要根据这两个启发算法中找到能右移动的最大值。接下来详细讨论坏字符算法和好后缀算法这两个启发式。        </li>
<li><strong>启发式</strong>        <ul>
<li><strong>坏字符算法</strong><br>  当出现一个坏字符时,BM算法向右移动模式串,让模式串中==最靠右的对应字符==与坏字符相对,然后继续匹配。坏字符算法有两种情况。      <ul>
<li>case 1: 模式串中不存在坏字符。这种情况直接右移模式串P的长度       <pre><code>  ![bm_bad_1](https://s.momocdn.com/w/u/others/2019/12/26/1577347131411-bm_bad_1.png)     
</code></pre>
  比如底下的第一次匹配的字符‘d’，在模式串中不存在，直接右移模式串长度     <pre><code>  ![bm_bad_11](https://s.momocdn.com/w/u/others/2019/12/26/1577347131365-bm_bad_11.png)       
</code></pre>
</li>
<li>case 2:模式串中有对应的坏字符时，让模式串中最==靠右的对应字符==与坏字符相对<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577347131453-bm_bad_2.png" alt="bm_bad_2">       比如还是上图，在第一次右移模式串P的长度后，模式串末尾的c和主串末尾的b不匹配，说明‘b’是坏字符，但是它在模式串P中有两个出现的位置，如果用从末尾开始数的第二个‘b’会太激进，漏掉匹配；所以得用==最右边==的‘b’去匹配，这就是坏字符算法的第二种case。<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577347131365-bm_bad_11.png" alt="bm_bad_11"></li>
</ul>
</li>
<li><strong>好后缀算法</strong><br>  如果匹配了一个好后缀, 并且在模式中还有另外一个相同的完整后缀或后缀的部分, 那把下一个完整后缀或部分移动到当前后缀位置。假如说，P的后u个字符和S都已经匹配了，但是接下来的一个字符不匹配(坏字符)，我需要移动才能匹配。如果说后u个字符在P其他位置也出现过或部分出现，我们将P右移到前面的u个字符或部分和最后的u个字符或部分相同，如果说后u个字符在P其他位置完全没有出现，直接右移整个pattern。这样，好后缀算法有三种情况:     <ul>
<li>case 1:<br>  模式串中有子串和好后缀==完全匹配==，则将==失配位置前最靠右==的那个子串移动到好后缀的位置继续进行匹配<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577347131411-bm_good_1.png" alt="bm_good_1">         比如下面的例子，第一步在5的位置text的‘c’和pattern的‘b’失配了，说明‘c’是个坏字符，并且‘c’在pattern中有出现，那按照上面坏字符算法的case 2移动pattern最右边的‘c’与text失配的位置5中去继续匹配。接下来在位置7中，text的‘a’和pattern的‘b’失配了，如果坏字符的规则相当于走回头路了，所以保守一点移动一步，有没有更好的？可以看到按好字后缀的定义，8和9位置的‘ab’是好的后缀，并且它们在pattern模式串中有‘ab’和它完全匹配，那就是这种case，移动到完全匹配的位置，这样一次移动了两步，多走了一步，优秀了一点。<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577349874546-bm_good_11.png" alt="bm_good_11">     </li>
<li>case 2:<br>  模式串种字串和好后缀只能部分匹配，那就从模式串中找到具有如下特征的最长子串,使得P[m-s…m]=P[0…s]。就是从模式串P的第0个元素开始找，找能匹配最长的部分模式串(为啥从0开始而不是找最右边出现的？)<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577347131453-bm_good_2.png" alt="bm_good_2">         比如下面的例子，一利用花字符算法移动4位，然后在位置4处text的‘a’和pattern的‘b’失配了，如果按坏字符规则要走回头路，所以保守一点右移一步？看看完整的好的后缀为‘cbab’，显然pattern中没有完整能匹配这个完整的‘cbab’后缀的，那就按这种case，取最长的在pattern中出现的部分后缀‘ab’去对应，但是这里有个限制，就是如果是部分后缀匹配，那==只能从pattern的头开始==。想下为啥得这样？这样的话拿pattern的头部的‘ab’去匹配text的部分后缀‘ab’，一下就移动了4位，➡又优秀。</li>
<li>case 3:<br>  如果完全不存在和好后缀匹配的子串，则右移整个模式串，这种情况和坏字符在pattern中没有出现一样，因为怎么都不会匹配成功的                     </li>
</ul>
</li>
</ul>
</li>
<li><strong>案例分析</strong><br>  接下来拿Moore教授自己的<span class="exturl" data-url="aHR0cDovL3d3dy5jcy51dGV4YXMuZWR1L35tb29yZS9iZXN0LWlkZWFzL3N0cmluZy1zZWFyY2hpbmcvZnN0cnBvcy1leGFtcGxlLmh0bWw=">案例<i class="fa fa-external-link-alt"></i></span>来分析整个过程，模式串为EXAMPLE，主串为：HERE IS A SIMPLE EXAMPLE        <ul>
<li>上来text的‘S’和pattern的‘E’不匹配，所以‘S’是坏字符，并且‘S’在pattern中不存在，所以按照坏字符算法case 1，直接向右移动pattern的长度7位。<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354552013-bm_demo_1.png" alt="bm_demo_1">       </li>
<li>接下来text的‘P’和pattern的‘E’不匹配，所以‘P’也是坏字符，但是‘P’在pattern中存在，所以按照坏字符算法case 2，让pattern中最靠右的‘P’与之对齐，也就是向右移动2位<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354552008-bm_demo_2.png" alt="bm_demo_2">       </li>
<li>按上面移动后<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551978-bm_demo_3.png" alt="bm_demo_3">       </li>
<li>然后从末尾开始依次往前面匹配<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354552009-bm_demo_4.png" alt="bm_demo_4"><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551882-bm_demo_5.png" alt="bm_demo_5"><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551857-bm_demo_6.png" alt="bm_demo_6"><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551825-bm_demo_7.png" alt="bm_demo_7"><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551911-bm_demo_8.png" alt="bm_demo_8">   </li>
<li>注意上面的红框，在text的‘I’和pattern的‘A’失配的时候，‘I’是坏字符，而‘E’，‘LE’，‘PLE’，‘MPLE’都是好的后缀。如果按坏字符的话，因为‘I’在pattern中没有出现，那么需要整个都移动到‘I’的后面，也就是下面这样移动，只能移动==3==位：<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551756-bm_demo_9.png" alt="bm_demo_9"><br>  但是因为有这么多的好后缀（MPLE、PLE、LE、E），根据上面好后缀算法，因为MPLE在失配位置前没有完全匹配的，所以case1不满足；接下从（PLE、LE、E）这些匹配的部分后缀中找能在失配位置前==最长的==，并且从pattern的0号位置头部开始的，那只有‘E’满足，所以把pattern头部的‘E’移到和text的‘E’一样的位置重新开始匹配。这样一次就移动了==6==位！显然这样更优秀。<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551619-bm_demo_11.png" alt="bm_demo_11">     </li>
<li>接下来继续从尾到头开始匹配，上来就失配了，满足坏字符的case2，所以找到pattern的最靠右边的字符‘P’去匹配<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551619-bm_demo_13.png" alt="bm_demo_13">     </li>
<li>从尾到头去匹配，匹配成功<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577354551592-bm_demo_14.png" alt="bm_demo_14">     </li>
</ul>
</li>
<li><strong>参考资料</strong><br>  <span class="exturl" data-url="aHR0cDovL3d3dy5jcy51dGV4YXMuZWR1L35tb29yZS9iZXN0LWlkZWFzL3N0cmluZy1zZWFyY2hpbmcvZnN0cnBvcy1leGFtcGxlLmh0bWw=">Moore教授自己的案例demo<i class="fa fa-external-link-alt"></i></span><br>  <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGFueHVlemFpcGlhby9wLzM0NTI1NzkuaHRtbA==">阿里小姐姐的分析过程<i class="fa fa-external-link-alt"></i></span><br>  <span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDEzLzA1L2JveWVyLW1vb3JlX3N0cmluZ19zZWFyY2hfYWxnb3JpdGhtLmh0bWw=">阮一峰的，得结合上面一起看<i class="fa fa-external-link-alt"></i></span>      </li>
</ul>
</li>
<li><p><strong>Sunday</strong>        </p>
<ul>
<li><strong>思路</strong><br>  Sunday算法最主要的特点是匹配失败的时候，关注的是主串中这一轮参与匹配的==最末位字符的下一位字符==，并且和BM不一样的是它是从前往后开始匹配。具体规则是：      <ul>
<li>如果该字符(主串失配位置的下一个字符)没有在模式串中出现则直接跳过它，即模式串右移位数 = 模式串长度 + 1。因为下一个不可能在模式串中存在，所以可以大胆的全部跳过它        </li>
<li>如果在模式串中存在，则模式串右移位数 = 模式串长度 - 该字符最右出现的位置(0开始算) = 模式串中该字符最右出现的位置到尾部的距离 + 1。和BM的坏字符的case 2类型，稳妥起见，拿最右边的相同的字符去对应匹配。     </li>
</ul>
</li>
<li><strong>案例分析</strong><br>  假设现在要在主串”substring searching”中查找模式串”search”。     <ul>
<li>刚开始时，把模式串和主串的左边对齐<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577362110097-sunday_1.png" alt="sunday_1">     </li>
<li>发现在第二个字符‘u’和‘e’的时候不匹配，根据规则，不匹配的时候关注主串这一轮参加匹配的的最末尾字符的下一个字符，即蓝色的‘i’，因为‘i’不在模式串中，所以向右移动位数 = 模式串长度 + 1 = 6 + 1 = 7，移动后如下图：<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577362109287-sunday_2.png" alt="sunday_2">     </li>
<li>继续匹配发现第一个字符就不匹配，按规则还是关注这一轮主串参加匹配的最末尾的字符的下一个字符，即蓝色的‘r’，发现它出现在模式串的倒数第3位，所以向右移动位数 = ‘r’到模式串末尾的距离 + 1 = 2 + 1 = 3，移动后如下图：<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577362109333-sunday_3.png" alt="sunday_3">     </li>
<li>匹配成功          </li>
</ul>
</li>
<li><strong>代码</strong><br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577364324709-sunday_code.png" alt="sunday_code">       </li>
<li><strong>缺点</strong><br>  Sunday算法的核心在向右移动位数move数组，这个依赖与模式串，所以有可能构造处很差的move数组(move数组的值都为1)，比如：<br>  主串：baaaabaaaabaaaabaaaa<br>  模式串：aaaaa<br>  这个模式串中，move[‘a’]的值都为1，因为最右边出现的‘a’就在末尾，所以每次失配时，只能让模式串移动1位，这就退化位BF的朴素算法了，时间复杂度也会飙升到o(m*n)，所以sunday不适合这种重复的模式串。      </li>
<li><strong>参考</strong><br>  <span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8yZTZlYjczODZjZDM=">参考资料<i class="fa fa-external-link-alt"></i></span>      </li>
</ul>
</li>
</ul>
</li>
<li><h4 id="3-基于hash"><a href="#3-基于hash" class="headerlink" title="3.基于hash"></a>3.基于hash</h4><ul>
<li><strong>Rabin-Karp算法</strong>        <ul>
<li><strong>背景</strong><br>  BF这种朴素的字符串匹配算法慢主要有两点：1.每一轮的比较都是一个字符一个字符去比较；2.前一次匹配的信息对于下一次匹配完全用不上。<br>  所以Rabin-Karp算法对这两点进行了改进：一是每一轮的匹配不用一个个字符去比较，而是把模式串和这一轮匹配的主串用对应的hash数值去比较，所以一次就能匹配完；二是当失配时，把第一字符去掉，然后把下一个字符加进去，重新计算hash，但是这次计算hash可以根据上次的hash在常数时间内快速的算出来，这样上一次匹配的信息也能充分利用起来      </li>
<li><strong>思路</strong><br>  比如我们要在源串”9876543210520”中查找”520”，因为这些字符串中只有数字，所以我们  可以使用字符集{‘0’,’1’,’2’,’3’,’4’,’5’,’6’,’7’,’8’,’9’}来表示字符串中的所有元   素，并且将各个字符映射到数字0～9，然后用M表示字符集中字符的总个数，这里是10，   那么我们就可以将搜索词 “987” 转化为下面的数值：<br>  (“9”的映射值 * M + “8”的映射值) * M + “7”的映射值 = (9 * 10 + 8) * 10 + 7 = 987   分析一下这个数值：987，它可以代表字符串 “987”，其中:<br>  代表字符 “9” 的部分是“ “9”的映射值 * (M 的 n - 1 次方) = 9 * (10 的 2 次方) = 900”<br>  代表字符 “8” 的部分是“ “8”的映射值 * (M 的 n - 2 次方) = 8 * (10 的 1 次方) = 80”<br>  代表字符 “7” 的部分是“ “7”的映射值 * (M 的 n - 3 次方) = 0 * (10 的 0 次方) = 7    其实这就是987按10进制的表达方式，同理可以去算模式串“520”的hash，显然这两个hash值不相等。接下来应该把‘9’去掉，把‘6’加进来。那如何利用前面‘987’计算的hash的信息呢？首先我们把 987 减去代表字符 “9” 的部分：987 - (“9”的映射值 * (M 的 n - 1 次方)) = 987 - (9 * (10 的 2 次方)) = 987 - 900 = 87，然后再乘以 M（这里是 10），再加上 “6” 的映射值，就成了‘876’ ：87 * M + “6”的映射值 = 87 * 10 + 6 = 876。然后根据这个规则继续匹配。当两个数值相等时，未必是真正的相等，我们需要进行一次细致的检查（再进行一次朴素的字符串比较）。若不匹配，则可以排除掉，防止hash碰撞的情况。        这里我们列举的是10进制的情况，如果是ASCII 字符集的话M可以取值128；这个M值尽量取较大的素数，这样使得更多的位参与运算减少hash碰撞。如果我们要在 Unicode 字符集范围内查找“搜索词”，由于 Unicode 字符集中有 1114112 个字符，那么 M 就等于 1114112，而 Go 语言中使用 ==16777619== <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvbGFuZy9nby9ibG9iL21hc3Rlci9zcmMvc3RyaW5ncy9zdHJpbmdzLmdv">Go的strings源码<i class="fa fa-external-link-alt"></i></span>作为 M 的值，16777619 比 1114112 大（更大的 M 值可以容纳更多的字符，这是可以的），而且 16777619 是一个素数。这样就可以使用上面的方法计算 Unicode 字符串的数值了。进而可以对 Unicode 字符串进行比较了。      </li>
<li><strong>代码</strong><br>  计算待匹配模式串sep的hash和最高位权重的值pow<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/26/1577367195724-rabin_karp_code.png" alt="rabin_karp_code">      匹配算法<br>  <img src="https://s.momocdn.com/w/u/others/2019/12/27/1577420152336-rabin_karp_code_2.png" alt="rabin_karp_code_2">       </li>
<li><strong>案例</strong><br>  比如在ABCDE里去匹配BCD，我们用q表示常数primeRK<br>  BCD的hash计算出来应该是B q^2 + C q + D<br>  ABC的hash应该是        A q^2 + B q + C<br>  当D来的时候如何操作的呢？根据之前的规则：<br>  [A q^2 + B q + C] q + D - A pow = A q^3 - A pow + B q^2 + C q + D<br>  而这个pow是可以和go源码里一样提前算出来的，所以在失陪时计算下一个hash能在常数时间快速得到，而两个hash值只是数值对比，一样快的飞起。</li>
<li><strong>参考</strong><br>  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dvbGFuZy9nby9ibG9iL21hc3Rlci9zcmMvc3RyaW5ncy9zdHJpbmdzLmdv">Go的strings源码<i class="fa fa-external-link-alt"></i></span><br>  <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZ29sb3ZlL3AvMzIzNDY3My5odG1s">参考资料1<i class="fa fa-external-link-alt"></i></span><br>  <span class="exturl" data-url="aHR0cHM6Ly93d3cubGlua2luc3Rhci53aWtpLzIwMTkvMDYvMjAvZ29sYW5nL3NvdXJjZS1jb2RlL3N0cmluZ3MtZ28tc291cmNlLWNvZGUv">参考资料2<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
</ul>
</li>
<li><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li><strong>AC算法</strong><br>  基于前缀的AC算法，构造goto表<br>  <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hseHhjYy9hcnRpY2xlL2RldGFpbHMvNjQxMzI0MDk=">参考资料<i class="fa fa-external-link-alt"></i></span>       </li>
<li><strong>Bitmap算法</strong><br>  用一个 bit 位来标记某个元素节省存储空间<br>  <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY2hhbnNodXlpL3AvNTI4NzgyNS5odG1s">参考资料<i class="fa fa-external-link-alt"></i></span></li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/luafile/index.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/luafile/index.html" class="post-title-link" itemprop="url">lua相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-14 11:25:42" itemprop="dateCreated datePublished" datetime="2021-09-14T11:25:42+08:00">2021-09-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/luafile/index.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/luafile/index.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><a href="./luacode">Lua源码学习</a></li>
<li><a href="./lua-patch">在iOS上面的应用，Lua热修复</a></li>
<li><a href="./lua">lua随缘记录</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/luafile/lua-patch.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/luafile/lua-patch.html" class="post-title-link" itemprop="url">lua_patch</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-14 11:25:42" itemprop="dateCreated datePublished" datetime="2021-09-14T11:25:42+08:00">2021-09-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lua/" itemprop="url" rel="index"><span itemprop="name">lua</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/luafile/lua-patch.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/luafile/lua-patch.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="源码我已公开至-github-持续更新维护"><a href="#源码我已公开至-github-持续更新维护" class="headerlink" title="源码我已公开至 github , 持续更新维护"></a>源码我已公开至 github , 持续更新维护</h1><p>访问链接如下<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dhbmdrZWppZS9sdWFfb2M=">https://github.com/wangkejie/lua_oc<i class="fa fa-external-link-alt"></i></span></p>
<h1 id="首先熟悉下lua和原生的交互"><a href="#首先熟悉下lua和原生的交互" class="headerlink" title="首先熟悉下lua和原生的交互"></a>首先熟悉下lua和原生的交互</h1><ol>
<li>__call 元方法</li>
<li>__index 元方法</li>
<li>__newindex 元方法</li>
<li>__gc </li>
</ol>
<p>还有很多 __add __mode等等。自行学习。</p>
<h1 id="方法说明"><a href="#方法说明" class="headerlink" title="方法说明"></a>方法说明</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/iOS/fishhook.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/iOS/fishhook.html" class="post-title-link" itemprop="url">fishhook</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-13 14:44:07" itemprop="dateCreated datePublished" datetime="2021-09-13T14:44:07+08:00">2021-09-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/iOS/fishhook.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/iOS/fishhook.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="iOS-14-5-下-fishhook-会-crash"><a href="#iOS-14-5-下-fishhook-会-crash" class="headerlink" title="iOS 14.5 下 fishhook 会 crash"></a>iOS 14.5 下 fishhook 会 crash</h1><p>github相关信息<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zpc2hob29rL2lzc3Vlcy84Mg==">github issue<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zpc2hob29rL3B1bGwvODQ=">resolve<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zpc2hob29rL3B1bGwvNjYvZmlsZXM=">protections ios13<i class="fa fa-external-link-alt"></i></span></p>
<p>Fishhook 考虑到过内存访问权限的问题，在 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zpc2hob29rL3B1bGwvNjUvZmlsZXM=">If hooking in __DATA_CONST, make writable before trying to write<i class="fa fa-external-link-alt"></i></span> 和 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zpc2hob29rL3B1bGwvNjYvZmlsZXM=">Properly restore protections for iOS 13<i class="fa fa-external-link-alt"></i></span> 这两个 PR 中，对于 __DATA_CONST 段中的数据，作者在</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indirect_symbol_bindings[i] <span class="operator">=</span> cur-&gt;rebindings[j].replacement<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>这一行赋值操作之前，使用了 <code>mprotect</code> 将所属内存区域的访问权限改成了“读写”，在这一行赋值操作以后，再次使用 <code>mprotect</code> 将所属内存区域的访问权限改回了原始值。</p>
<p>然而这两个 PR 其实是有问题的：<br>1、mprotect 修改内存区域的访问权限时，传入的内存地址是需要按页对齐的，所以开源版本的 fishhook 在旧版 iOS 系统上，mprotect 都有很大概率不成功（返回 -1），<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvYXJjaGl2ZS9kb2N1bWVudGF0aW9uL1N5c3RlbS9Db25jZXB0dWFsL01hblBhZ2VzX2lQaG9uZU9TL21hbjIvbXByb3RlY3QuMi5odG1s">官方文档<i class="fa fa-external-link-alt"></i></span>也印证了这点。</p>
<p>2、oldProtection = get_protection(rebindings); 这一行的目的是保存原先的访问权限，但是传入的参数是错误的，这会导致“在这一行赋值操作以后，再次使用 mprotect 将所属内存区域的访问权限改回了原始值”在实际执行中，“改回了原始值”实际是“改成可读写”（当然由于 mprotect 页对齐的问题很大概率修改不成功），因为 rebindings 是 malloc 出来的。</p>
<p>所以，一直以来，这两个 PR 大概率没有发挥预期的作用， indirect_symbol_bindings[i] 所在的内存区域，如果在程序启动后是只读的，那么 fishhook 的过程中，它也是只读的。只要赋值，就会触发 crash。</p>
<h1 id="查看小技巧"><a href="#查看小技巧" class="headerlink" title="查看小技巧"></a>查看小技巧</h1><p>1、无论是 iOS 14.4 还是 iOS 14.5，mprotect 修改内存区域为读写时，都失败了（返回 -1）。<br>2、但是在 mprotect 修改前，iOS 14.4 上 indirect_symbol_bindings[i] 所在的内存区域是读写的，而 iOS 14.5 上变成了只读。<br>为了便于理解，我们可以在程序启动后、fishhook 开始前，通过 memory graph 来观察各个内存区域的访问权限：</p>
<blockquote>
<p>抓取 memory graph 后，在 Xcode 中选择 File -&gt; Export Memory Graph，导出 memory graph 后使用 vmmap 命令得到各个内存区域的快照</p>
</blockquote>
<p>观察 libxpc.dylib 的 __DATA_CONST 段映射在内存中的访问权限：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iOS 14.5 </span></span><br><span class="line">__DATA_CONST                <span class="number">1</span>edadef10-<span class="number">1</span>edae35c0    [   <span class="number">18</span>K    <span class="number">18</span>K     <span class="number">4</span>K     <span class="number">0</span>K] r--<span class="regexp">/rw- SM=COW          /u</span>sr<span class="regexp">/lib/</span>system/libxpc.dylib</span><br><span class="line"><span class="comment"># iOS 14.4</span></span><br><span class="line">__DATA_CONST                <span class="number">1</span>f30167b0-<span class="number">1</span>f301ae70    [   <span class="number">18</span>K    <span class="number">18</span>K     <span class="number">6</span>K     <span class="number">0</span>K] rw-<span class="regexp">/rw- SM=COW          /u</span>sr<span class="regexp">/lib/</span>system/libxpc.dylib</span><br></pre></td></tr></table></figure>

<p>可以发现，iOS 14.5 中，libxpc.dylib 的 __DATA_CONST 段是只读的，而 iOS 14.4 中是读写的。<br>同时观察其他系统库，能发现 iOS 14.5 中，不少系统库的 __DATA_CONST 段都从 iOS 14.4 的读写变成了只读，同时撞上了一直以来都有的 mprotect 失效的问题，所以产生了 crash。</p>
<p>解决参考上面issue, 核心代码如下</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">mprotect</span><span class="params">((void *)</span><span class="title">trunc_address</span>, <span class="title">section</span>-&gt;</span>size+trunc_size, PROT_READ | PROT_WRITE);</span><br></pre></td></tr></table></figure>

<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">trunc_address = trunc_page((<span class="name">vm_size_t</span>)indirect_symbol_bindings)<span class="comment">;</span></span><br><span class="line">trunc_size =(<span class="name">vm_size_t</span>)indirect_symbol_bindings -trunc_address<span class="comment">;</span></span><br><span class="line">pthread_mutex_lock(<span class="name">&amp;mutex</span>)<span class="comment">;</span></span><br><span class="line">oldProtection = get_protection((<span class="name">void</span> *)trunc_address);</span><br><span class="line">mprotect((void *)trunc_address, section-&gt;size+trunc_size, PROT_READ | PROT_WRITE)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/os/dyld.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/os/dyld.html" class="post-title-link" itemprop="url">dyld和启动流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-10 18:34:55" itemprop="dateCreated datePublished" datetime="2021-09-10T18:34:55+08:00">2021-09-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/os/" itemprop="url" rel="index"><span itemprop="name">os</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/os/dyld/" itemprop="url" rel="index"><span itemprop="name">dyld</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/os/dyld.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/os/dyld.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="先看一个断点"><a href="#先看一个断点" class="headerlink" title="先看一个断点"></a>先看一个断点</h1><img src="/images/iOS/dyld_mainluanch.png" class="" title="启动流程">

<h1 id="App-Launch-以及-dyld"><a href="#App-Launch-以及-dyld" class="headerlink" title="App Launch 以及 dyld"></a>App Launch 以及 dyld</h1><p>自行下载参考dyld源码，下面只是我的简要记录</p>
<p>dyldbootstrap::start<br>{<br>rebaseDyld 符号便宜aslr address layout random<br>__guard_setup 栈溢出保护<br>dyld::_main<br>}</p>
<p>rebaseDyld {<br>    遍历所有固定的 chains 然后 rebase dyld<br>    所有基于修正链的映像的基地址为零，因此slide == 加载地址</p>
<pre><code>  // now that rebasing done, initialize mach/syscall layer
mach_init(); // from libc.a
</code></pre>
<p>}</p>
<h2 id="重点分析的方法"><a href="#重点分析的方法" class="headerlink" title="重点分析的方法"></a>重点分析的方法</h2><blockquote>
<p>dyld::_main分析</p>
</blockquote>
<ol>
<li><p>初始化程序运行环境</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//获取主程序的macho_header结构以及主程序的slide偏移值</span></span><br><span class="line">sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line">sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">//获取主程序路径</span></span><br><span class="line"><span class="comment">// Pickup the pointer to the exec path.</span></span><br><span class="line">sExecPath = _simple_getenv(apple, <span class="string">&quot;executable_path&quot;</span>);</span><br><span class="line"> <span class="keyword">if</span> (!sExecPath) sExecPath = apple[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> ( sExecPath[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span> ) &#123;</span><br><span class="line">    <span class="comment">// have relative path, use cwd to make absolute</span></span><br><span class="line">   ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取进程名称</span></span><br><span class="line"><span class="comment">// Remember short name of process for later logging</span></span><br><span class="line">sExecShortName = ::<span class="built_in">strrchr</span>(sExecPath, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> ( sExecShortName != <span class="literal">NULL</span> )</span><br><span class="line">    ++sExecShortName;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    sExecShortName = sExecPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">//配置进程受限模式</span></span><br><span class="line">configureProcessRestrictions(mainExecutableMH, envp);</span><br><span class="line"></span><br><span class="line"><span class="comment">//检测环境变量</span></span><br><span class="line">checkEnvironmentVariables(envp);</span><br><span class="line">defaultUninitializedFallbackPaths(envp);</span><br><span class="line"></span><br><span class="line">`所谓的启动优化就是在这里，添加dyly参数，进行打印的`</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否设置了sEnv.DYLD_PRINT_OPTS以及sEnv.DYLD_PRINT_ENV，分别打印argv参数和envp环境变量</span></span><br><span class="line"><span class="keyword">if</span> ( sEnv.DYLD_PRINT_OPTS )</span><br><span class="line">    printOptions(argv);</span><br><span class="line"><span class="keyword">if</span> ( sEnv.DYLD_PRINT_ENV ) </span><br><span class="line">    printEnvironmentVariables(envp);</span><br><span class="line"><span class="comment">//获取当前程序架构</span></span><br><span class="line">getHostInfo(mainExecutableMH, mainExecutableSlide);</span><br></pre></td></tr></table></figure></li>
<li><p>加载共享缓存 shared cache<br> mapSharedCache();</p>
</li>
<li><p>实例化主程序，并赋值给ImageLoader::LinkContext</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">try &#123;</span><br><span class="line">    <span class="comment">// add dyld itself to UUID list</span></span><br><span class="line">    addDyldImageToUUIDList();</span><br><span class="line">    sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br><span class="line">    gLinkContext.mainExecutable = sMainExecutable;</span><br><span class="line">    gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>加载插入的动态库++++++++++++++++++++</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// load any inserted libraries</span></span><br><span class="line"><span class="keyword">if</span>  ( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="type">char</span>* <span class="type">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">        loadInsertedDylib(*lib);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>链接主程序++++++++++++++</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gLinkContext.linkingMainExecutable = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">link</span>(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader<span class="type">::RPathChain</span>(<span class="built_in">NULL</span>, <span class="built_in">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">sMainExecutable-&gt;setNeverUnloadRecursive();</span><br></pre></td></tr></table></figure></li>
<li><p>链接插入的动态库++++++++</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">ImageLoader::apply<span class="constructor">InterposingToDyldCache(<span class="params">gLinkContext</span>)</span>;</span><br><span class="line"> <span class="comment">// Bind and notify for the inserted images now interposing has been registered</span></span><br><span class="line"><span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="keyword">for</span>(unsigned <span class="built_in">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">        ImageLoader* image = sAllImages<span class="literal">[<span class="identifier">i</span>+<span class="number">1</span>]</span>;</span><br><span class="line">        image-&gt;recursive<span class="constructor">Bind(<span class="params">gLinkContext</span>, <span class="params">sEnv</span>.DYLD_BIND_AT_LAUNCH, <span class="params">true</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>在链接所有插入的image后，执行弱绑定++++++++++++++++++++++++++++++</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked</span></span><br><span class="line">sMainExecutable-&gt;weak<span class="constructor">Bind(<span class="params">gLinkContext</span>)</span>;</span><br><span class="line">gLinkContext.linkingMainExecutable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">sMainExecutable-&gt;recursive<span class="constructor">MakeDataReadOnly(<span class="params">gLinkContext</span>)</span>;   </span><br></pre></td></tr></table></figure></li>
<li><p>执行所有的初始化方法+++++++++++++++++++++</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// run all initializers</span></span><br><span class="line"><span class="built_in">initializeMainExecutable</span>(); </span><br></pre></td></tr></table></figure></li>
<li><p>查找主程序的入口点并返回</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// find entry point for main executable</span></span><br><span class="line">    result = (<span class="built_in">uint</span>ptr_t)sMainExecutable-&gt;getEntryFromLC_MAIN(); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="总结dyld-main主要做了以下操作-就不一一分析了-："><a href="#总结dyld-main主要做了以下操作-就不一一分析了-：" class="headerlink" title="总结dyld::_main主要做了以下操作(就不一一分析了)："></a>总结dyld::_main主要做了以下操作(就不一一分析了)：</h2><p>主程序运行环境初始化及配置，拿到Mach-O头文件 (macho_header里面包含整个Mach-O文件信息其中包括所有链入的动态库信息)<br>加载共享缓存 shared cache<br>实例化主程序，并赋值给ImageLoader::LinkContext<br>加载所有插入的动态库，将可执行文件以及相应的依赖库与插入库加载进内存生成对应的ImageLoader类的image(镜像文件)对象<br>链接主程序（必须先链接主程序后才能插入）<br>链接所有的动态库ImageLoader的image(镜像文件)对象，并注册插入的信息，方便后续进行绑定<br>在链接完所有插入的动态库镜像文件之后执行弱绑定<br>执行所有动态库image的初始化方法initializeMainExecutable<br>查找主程序的入口点LC_MAIN并返回result结果，结束整个_dyld_start流程，进入我们App的main()函数！</p>
<h2 id="这里解释一下共享缓存机制：网上自己查询-dyld1-0版本-dyld3-版本，-当前使用dyld3版本"><a href="#这里解释一下共享缓存机制：网上自己查询-dyld1-0版本-dyld3-版本，-当前使用dyld3版本" class="headerlink" title="这里解释一下共享缓存机制：网上自己查询  dyld1.0版本 - dyld3 版本， 当前使用dyld3版本"></a>这里解释一下共享缓存机制：网上自己查询  dyld1.0版本 - dyld3 版本， 当前使用dyld3版本</h2><blockquote>
<p>dyld加载时，为了优化程序启动，在dyld::_main中启用了共享缓存（shared cache）技术。共享缓存会在进程启动时被dyld映射到内存中，之后，当任何Mach-O映像加载时，dyld首先会检查该Mach-O映像与所需的动态库是否在共享缓存中，如果存在，则直接将它在共享内存中的内存地址映射到进程的内存地址空间。在程序依赖的系统动态库很多的情况下，这种做法对程序启动性能会有明显提升。</p>
</blockquote>
<h2 id="分析一下-main的第8步，initializeMainExecutable-倒数第二步"><a href="#分析一下-main的第8步，initializeMainExecutable-倒数第二步" class="headerlink" title="分析一下_main的第8步，initializeMainExecutable()  倒数第二步"></a>分析一下_main的第8步，initializeMainExecutable()  倒数第二步</h2><p>自行根据下面的方法阅读源码<br><code>initializeMainExecutable -&gt; runInitializers -&gt; processInitializers -&gt; recursiveInitialization -&gt; notifySingle</code></p>
<p>最后我想说的就是这个notifySingle，</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.notify<span class="constructor">Single(<span class="params">dyld_image_state_dependents_initialized</span>, <span class="params">this</span>, &amp;<span class="params">timingInfo</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>找到一个关键的函数指针* sNotifyObjCInit,  全局搜索找到赋值  </p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void register<span class="constructor">ObjCNotifiers(<span class="params">_dyld_objc_notify_mapped</span> <span class="params">mapped</span>, <span class="params">_dyld_objc_notify_init</span> <span class="params">init</span>, <span class="params">_dyld_objc_notify_unmapped</span> <span class="params">unmapped</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// record functions to call</span></span><br><span class="line">    sNotifyObjCMapped   = mapped;</span><br><span class="line">    sNotifyObjCInit     = init;</span><br><span class="line">    sNotifyObjCUnmapped = unmapped;<span class="operator"></span></span><br><span class="line"><span class="operator"></span></span><br><span class="line"><span class="operator">    ...</span></span><br><span class="line"><span class="operator"></span>&#125;</span><br></pre></td></tr></table></figure>

<p>全局搜索，看看registerObjCNotifiers这个方法会被谁调用，找到调用的地方_dyld_objc_notify_register函数</p>
<blockquote>
<p>不用找了，在objc的源码里面， <code>_dyld_objc_notify_register</code> 是 <code>_objc_init</code>进行调用的。而_objc_init函数则是Runtime的入口函数！</p>
</blockquote>
<p>打开Objc源码,搜索_objc_init</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/<span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">*</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">*</span> <span class="emphasis">_objc_</span>init</span></span><br><span class="line"><span class="strong"><span class="emphasis">* Bootstrap initialization. Registers our image notifier with dyld.</span></span></span><br><span class="line"><span class="emphasis"><span class="strong">*</span> Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="strong">**</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>/</span><br><span class="line"></span><br><span class="line">void <span class="emphasis">_objc_</span>init(void)</span><br><span class="line">&#123;</span><br><span class="line"><span class="code">    static bool initialized = false;</span></span><br><span class="line"><span class="code">    if (initialized) return;</span></span><br><span class="line"><span class="code">    initialized = true;</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    // fixme defer initialization until an objc-using image is found?</span></span><br><span class="line"><span class="code">    environ_init();</span></span><br><span class="line"><span class="code">    tls_init();</span></span><br><span class="line"><span class="code">    static_init();</span></span><br><span class="line"><span class="code">    lock_init();</span></span><br><span class="line"><span class="code">    exception_init();</span></span><br><span class="line"><span class="code">    </span></span><br><span class="line"><span class="code">    //注册回调函数</span></span><br><span class="line"><span class="code">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>

<p>看 <code>_dyld_objc_notify_register</code> 注释</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">* _objc_init</span></span><br><span class="line"><span class="comment">* Bootstrap initialization. Registers our image notifier with dyld. </span></span><br><span class="line"><span class="comment">* //引导程序初始化。 用dyld注册我们的image通知程序。</span></span><br><span class="line"><span class="comment">* Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="comment">* //在库初始化之前由libSystem调用!!!!!</span></span><br><span class="line"><span class="comment">* </span></span><br></pre></td></tr></table></figure>

<p>_objc_init的调用时机是在其他动态库加载之前由libSystem系统库先调用的。</p>
<p>那么到现在就很明确了，其实在dyld::_main主程序的第8步，初始化所有动态库及主程序的时候之前，就先注册了load_images的回调，之后在Runtime调用load_images加载完所有load方法之后，就会回调到dyld::_main的initializeMainExecutable()内部执行回调。</p>
<h1 id="map-images"><a href="#map-images" class="headerlink" title="map_images"></a>map_images</h1><p>自行下载objc源码, 找打 <code>_objc_init</code> 方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _objc_init</span></span><br><span class="line"><span class="comment">* Bootstrap initialization. Registers our image notifier with dyld.</span></span><br><span class="line"><span class="comment">* Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _objc_init(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//读取影响运行时的环境变量。</span></span><br><span class="line">    environ_init();</span><br><span class="line">    </span><br><span class="line">    tls_init();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//运行C ++静态构造函数。libc在dyld调用我们的静态构造函数之前调用_objc_init()</span></span><br><span class="line">    static_init();</span><br><span class="line">    </span><br><span class="line">    lock_init();</span><br><span class="line">    <span class="comment">//初始化libobjc的异常处理系统。由map_images()调用。</span></span><br><span class="line">    exception_init();</span><br><span class="line"></span><br><span class="line">    注册回调函数</span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="map-images直接返回了map-images-nolock-直接看实现"><a href="#map-images直接返回了map-images-nolock-直接看实现" class="headerlink" title="map_images直接返回了map_images_nolock,直接看实现"></a>map_images直接返回了map_images_nolock,直接看实现</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> </span><br><span class="line"><span class="title function_">map_images_nolock</span><span class="params">(<span class="type">unsigned</span> mhCount, <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> mhPaths[],</span></span><br><span class="line"><span class="params">                  <span class="type">const</span> <span class="keyword">struct</span> mach_header * <span class="type">const</span> mhdrs[])</span></span><br><span class="line">&#123;</span><br><span class="line">    定义一系列变量</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    必要时执行首次初始化</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果是第一次，就准备初始化环境</span></span><br><span class="line">    <span class="keyword">if</span> (firstTime) &#123;</span><br><span class="line">        preopt_init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find all images with Objective-C metadata.</span></span><br><span class="line">    hCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    计算<span class="class"><span class="keyword">class</span>数量，根据总数调整各种表的大小。</span></span><br><span class="line"><span class="class">    // <span class="title">Count</span> <span class="title">classes</span>. <span class="title">Size</span> <span class="title">various</span> <span class="title">table</span> <span class="title">based</span> <span class="title">on</span> <span class="title">the</span> <span class="title">total</span>.</span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">totalClasses</span> =</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> unoptimizedTotalClasses = <span class="number">0</span>;</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    执行一次运行时初始化，必须将其推迟到找到可执行文件本身为止。 这需要在进一步初始化之前完成。（如果可执行文件不包含Objective-C代码，但稍后会动态加载Objective-C，则该可执行文件可能不会出现在此infoList中。</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (firstTime) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//初始化sel方法表 并注册系统内部专门的方法。</span></span><br><span class="line">        sel_init(selrefCount);</span><br><span class="line">        arr_init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    直接开始image读取</span><br><span class="line">    <span class="keyword">if</span> (hCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    firstTime = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结map_images_nolock的流程就是:</p>
<ul>
<li>判断firstTime，firstTime为YES，则执行环境初始化的准备，为NO就不执行</li>
<li>计算class数量，根据总数调整各种表的大小并做了GC相关逻辑处理(不支持GC则打印提示信息)</li>
<li>判断firstTime，firstTime为YES，执行各种表初始化操作，为NO则不执行</li>
<li>执行<code>_read_images</code>进行读取，然后将firstTime置为NO，就不再进入上面的逻辑了，下次进入map_images_nolock就开始直接_read_images</li>
</ul>
<h2 id="接下来我们重点分析-read-images"><a href="#接下来我们重点分析-read-images" class="headerlink" title="接下来我们重点分析_read_images"></a>接下来我们重点分析<code>_read_images</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* _read_images</span></span><br><span class="line"><span class="comment">* Perform initial processing of the headers in the linked </span></span><br><span class="line"><span class="comment">* list beginning with headerList. </span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Called by: map_images_nolock</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Locking: runtimeLock acquired by map_images</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="type">void</span> _read_images(header_info **hList, <span class="type">uint32_t</span> hCount, <span class="type">int</span> totalClasses, <span class="type">int</span> unoptimizedTotalClasses)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    定义一系列局部变量</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="number">1.</span> 重新初始化TaggedPointer环境****************</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!doneOnce) &#123;</span><br><span class="line">        doneOnce = YES;</span><br><span class="line"></span><br><span class="line">         ......</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DisableTaggedPointers) &#123;</span><br><span class="line">            disableTaggedPointers();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        initializeTaggedPointerObfuscator();</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        注意！！！！！创建表 gdb_objc_realized_classes 和 allocatedClasses</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> namedClassesSize = </span><br><span class="line">            (isPreoptimized() ? unoptimizedTotalClasses : totalClasses) * <span class="number">4</span> / <span class="number">3</span>;</span><br><span class="line">        gdb_objc_realized_classes =</span><br><span class="line">            NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize);</span><br><span class="line">        </span><br><span class="line">        allocatedClasses = NXCreateHashTable(NXPtrPrototype, <span class="number">0</span>, nil);</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Discover classes. Fix up unresolved future classes. Mark bundle classes.</span></span><br><span class="line">    </span><br><span class="line">    <span class="number">2.</span> 开始遍历头文件，进行类与元类的读取操作并标记(旧类改动后会生成新的类，并重映射到新的类上)************************</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        <span class="comment">//从头文件中拿到类的信息</span></span><br><span class="line">        <span class="type">classref_t</span> *classlist = _getObjc2ClassList(hi, &amp;count);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (! mustReadClasses(hi)) &#123;</span><br><span class="line">            <span class="comment">// Image is sufficiently optimized that we need not call readClass()</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">bool</span> headerIsBundle = hi-&gt;isBundle();</span><br><span class="line">        <span class="type">bool</span> headerIsPreoptimized = hi-&gt;isPreoptimized();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            Class cls = (Class)classlist[i];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//!!!!!!核心操作，readClass读取类的信息及类的更新</span></span><br><span class="line">            Class newCls = readClass(cls, headerIsBundle, headerIsPreoptimized);</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="number">3.</span> 读取@selector*************************************</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Fix up @selector references</span></span><br><span class="line">    <span class="type">static</span> <span class="type">size_t</span> UnfixedSelectors;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">mutex_locker_t</span> <span class="title function_">lock</span><span class="params">(selLock)</span>;</span><br><span class="line">        <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hi-&gt;isPreoptimized()) <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">bool</span> isBundle = hi-&gt;isBundle();</span><br><span class="line">            SEL *sels = _getObjc2SelectorRefs(hi, &amp;count);</span><br><span class="line">            UnfixedSelectors += count;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">                <span class="type">const</span> <span class="type">char</span> *name = sel_cname(sels[i]);</span><br><span class="line">                sels[i] = sel_registerNameNoLock(name, isBundle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="number">4.</span> 读取协议protocol*************************************</span><br><span class="line">    <span class="comment">// Discover protocols. Fix up protocol refs.</span></span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        <span class="keyword">extern</span> objc_class OBJC_CLASS_$_Protocol;</span><br><span class="line">        Class cls = (Class)&amp;OBJC_CLASS_$_Protocol;</span><br><span class="line">        assert(cls);</span><br><span class="line">        NXMapTable *protocol_map = protocols();</span><br><span class="line">        <span class="type">bool</span> isPreoptimized = hi-&gt;isPreoptimized();</span><br><span class="line">        <span class="type">bool</span> isBundle = hi-&gt;isBundle();</span><br><span class="line"></span><br><span class="line">        <span class="type">protocol_t</span> **protolist = _getObjc2ProtocolList(hi, &amp;count);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            readProtocol(protolist[i], cls, protocol_map, </span><br><span class="line">                         isPreoptimized, isBundle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="number">5.</span> 处理分类category，并rebuild重建这个类的方法列表method <span class="built_in">list</span>*******************************</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Discover categories. </span></span><br><span class="line">    <span class="keyword">for</span> (EACH_HEADER) &#123;</span><br><span class="line">        <span class="type">category_t</span> **catlist = </span><br><span class="line">            _getObjc2CategoryList(hi, &amp;count);</span><br><span class="line">        <span class="type">bool</span> hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            <span class="type">category_t</span> *cat = catlist[i];</span><br><span class="line">            Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">            </span><br><span class="line">            ......</span><br><span class="line">            </span><br><span class="line">            <span class="type">bool</span> classExists = NO;</span><br><span class="line">            <span class="keyword">if</span> (cat-&gt;instanceMethods ||  cat-&gt;protocols  </span><br><span class="line">                ||  cat-&gt;instanceProperties) </span><br><span class="line">            &#123;</span><br><span class="line">                addUnattachedCategoryForClass(cat, cls, hi);</span><br><span class="line">                <span class="keyword">if</span> (cls-&gt;isRealized()) &#123;</span><br><span class="line">                    remethodizeClass(cls);</span><br><span class="line">                    classExists = YES;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">                    _objc_inform(<span class="string">&quot;CLASS: found category -%s(%s) %s&quot;</span>, </span><br><span class="line">                                 cls-&gt;nameForLogging(), cat-&gt;name, </span><br><span class="line">                                 classExists ? <span class="string">&quot;on existing class&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cat-&gt;classMethods  ||  cat-&gt;protocols  </span><br><span class="line">                ||  (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) </span><br><span class="line">            &#123;</span><br><span class="line">                addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi);</span><br><span class="line">                <span class="keyword">if</span> (cls-&gt;ISA()-&gt;isRealized()) &#123;</span><br><span class="line">                    remethodizeClass(cls-&gt;ISA());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">                    _objc_inform(<span class="string">&quot;CLASS: found category +%s(%s)&quot;</span>, </span><br><span class="line">                                 cls-&gt;nameForLogging(), cat-&gt;name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DebugNonFragileIvars) &#123;</span><br><span class="line">        realizeAllClasses();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    最后是一堆打印***********</span><br><span class="line">    ......</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>_read_images的实现主要分为以下步骤：</p>
<ol>
<li>重新初始化TaggedPointer环境</li>
<li>开始遍历头文件，进行类与元类的读取操作并标记(旧类改动后会生成新的类，并重映射到新的类上)</li>
<li>读取@selector方法</li>
<li>读取协议protocol</li>
<li>处理分类category，并rebuild重建这个类的方法列表method list</li>
</ol>
<p>两个表，一个叫<code>gdb_objc_realized_classes</code>用来存放已命名的类的列表，另一个叫<code>allocatedClasses</code>用来存放已分配的所有类(和元类)</p>
<h2 id="逐步分析-readClass、-selector、-protocol、-category"><a href="#逐步分析-readClass、-selector、-protocol、-category" class="headerlink" title="逐步分析 readClass、@selector、 protocol、 category"></a>逐步分析 readClass、@selector、 protocol、 category</h2><h3 id="从源码中可以看出，-readClass-方法有返回值，并且包含三种逻辑处理："><a href="#从源码中可以看出，-readClass-方法有返回值，并且包含三种逻辑处理：" class="headerlink" title="从源码中可以看出， readClass 方法有返回值，并且包含三种逻辑处理："></a>从源码中可以看出， readClass 方法有返回值，并且包含三种逻辑处理：</h3><ul>
<li>找不到该类的父类，可能是弱绑定，直接返回nil；</li>
<li>找到类了，判断这个类是否是一个future的类(可以理解为需要实现的一个类，也可以理解为这个类是否有变化)，如果有变化则创建新类，并把旧类的数据拷贝一份然后赋值给新类newCls，然后调用addRemappedClass进行重映射，用新的类替换掉旧的类，并返回新类newCls的地址</li>
<li>找到类了，如果类没有任何变化，则不进行任何操作，直接返回class</li>
</ul>
<p>从readClass的底层实现部分做个延伸思考：日常开发中，对于已经启动完成的工程项目，如果我们未修改任何类的数据，那么再次点击运行会很快完成，但是一旦我们在对这些类进行修改后，在读取这些类的信息(包括类本身的信息以及下面我们要继续分析的协议protocol、分类category、方法selector)，就需要对该类的数据进行更新，这个更新实际上是新建一个类，然后拷贝旧类的数据赋值给新类，然后重映射并用新类替换掉新类，这里面的拷贝以及读写过程其实是相当耗时的！这是类信息改动之后项目再次Run运行起来会比较慢的原因之一。</p>
<p>已经读取完成的类，会被存放到了这个表<code>gdb_objc_realized_classes</code>里面！</p>
<p>分析源码注释及源码得出，<code>addClassTableEntry</code>里面会把这个读取完成的类直接先添加到<code>allocatedClasses</code>表里面，然后再判断<code>addMeta</code>是否为YES，然后会把当前这个类的元类metaClass也添加到<code>allocatedClasses</code>这个表里面。</p>
<h3 id="selector"><a href="#selector" class="headerlink" title="@selector"></a>@selector</h3><p>点击sel_registerNameNoLock，找到__sel_registerName，在它里面找到关键代码<br>逻辑其实就是：把方法名插入并存储到namedSelectors这个表里面.</p>
<h3 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h3><p>找到关键函数readProtocol，进入发现其实读取protocol的操作是把protocol存进协议表protocol_map。</p>
<h3 id="category"><a href="#category" class="headerlink" title="category"></a>category</h3><p>分类category的读取，里面主要做了下面这些步骤：</p>
<ol>
<li>从头文件中获取所有的分类列表catlist，然后循环遍历这个列表</li>
<li>在循环中，判断当前分类cat所属的类是否存在，如果不存在则把这个分类置为空catlist[i] = nil; 如果这个分类所属的类存在，那么开始下面两个步骤：</li>
<li>第一个步骤：判断这个分类cat中是否有实例方法instanceMethods，协议protocols以及属性实例instanceProperties，如果有，那么进入remethodizeClass，重新rebuild当前类cls的方法列表</li>
<li>第二个步骤：继续判断这个分类cat中是否有类方法classMethods，协议protocols以及类属性_classProperties，然后重新rebuild当前类所对应元类cls-&gt;ISA()的方法列表。</li>
</ol>
<h1 id="loadimage"><a href="#loadimage" class="headerlink" title="loadimage"></a>loadimage</h1><p>调用load方法，父类-子类-所有分类</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>_objc_init 是系统库，很早就已经 由libSystem系统库先调用的，初始化了很多环境 其中有<code>_dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</code></p>
<p>dyld 初始化进程环境，链接动态库，进行 _dyld_objc_notify_register 注册 </p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9lYTY4MDk0MWUwODQ=">https://www.jianshu.com/p/ea680941e084<i class="fa fa-external-link-alt"></i></span></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wangkejie.com/sumup/sumupthepast.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Jack Wang">
      <meta itemprop="description" content="书山有路勤为径，学海无涯苦作舟！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王科杰">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/sumup/sumupthepast.html" class="post-title-link" itemprop="url">总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-05 10:14:47" itemprop="dateCreated datePublished" datetime="2021-09-05T10:14:47+08:00">2021-09-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%80%BB%E7%BB%93/" itemprop="url" rel="index"><span itemprop="name">总结</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/sumup/sumupthepast.html#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/sumup/sumupthepast.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="回看过去，做了什么，能否沉淀些东西，简要记录"><a href="#回看过去，做了什么，能否沉淀些东西，简要记录" class="headerlink" title="回看过去，做了什么，能否沉淀些东西，简要记录"></a>回看过去，做了什么，能否沉淀些东西，简要记录</h1><h2 id="组件化"><a href="#组件化" class="headerlink" title="组件化"></a>组件化</h2><p>详细的内容在另外一个组件化篇幅里记录</p>
<ol>
<li>组件化目的：</li>
</ol>
<ul>
<li>共享基础设施</li>
<li>下沉公共服务</li>
<li>隔离业务代码(模块儿)</li>
<li>二进制加速编译，带上dwarf符号信息，和源文件</li>
<li>开启modular，支持swift混编<ul>
<li>主要是解决头文件引用问题</li>
<li>需要采用’&lt;&gt;’尖括号形式，兼容modular和framework</li>
</ul>
</li>
</ul>
<ol start="2">
<li>X点</li>
</ol>
<ul>
<li>借鉴Beehive, 注解方式注册。 类似于java的框架spring的模式，</li>
<li>使用自定义goto字符串协议</li>
<li>统一管理cocoapods版本号，利用bundle工具管理版本号</li>
<li>由于podfile.lock和menifest.lock文件不一致问题，把pod文件加入版本控制</li>
</ul>
<h2 id="热更新方案"><a href="#热更新方案" class="headerlink" title="热更新方案"></a>热更新方案</h2><ol>
<li><p>方法中带block的, </p>
<ul>
<li>block在原神生成，在脚本中调用</li>
<li>block需要在脚本中生成，在原生调用</li>
</ul>
</li>
<li><p>hook方法，msgforwarding，</p>
</li>
<li><p>利用libffi调用原生C函数，</p>
</li>
<li><p>通过符号找函数地址，dlsym，或者fishhook的方案，利用segment_linkedit, lc_symta（字符表和符号表）b, lc_dysymtab(间接符号表，系统/第三方的导出符号)</p>
</li>
</ol>
<h2 id="CRASH-amp-amp-APM"><a href="#CRASH-amp-amp-APM" class="headerlink" title="CRASH &amp;&amp; APM"></a>CRASH &amp;&amp; APM</h2><ol>
<li>可捕获的<ul>
<li>C++、OC、数组越界、抛异常等软件异常</li>
<li>断言等</li>
</ul>
</li>
<li>不可捕获的，或者说是abort<ul>
<li>oom</li>
<li>anr</li>
<li>死锁</li>
<li>非法应用签名</li>
<li>后台超时</li>
<li>内存紧张</li>
<li>设备过热</li>
</ul>
</li>
<li>crash监控<ul>
<li>注册监听，CPPException，OCException、singal、machException</li>
</ul>
</li>
</ol>
<h2 id="聊天室业务"><a href="#聊天室业务" class="headerlink" title="聊天室业务"></a>聊天室业务</h2><ol>
<li>架构调整</li>
</ol>
<ul>
<li>mvp为主。 管理各种有戏模板，抽取模板抽象类，统一调度，抽取基类，反向调用</li>
<li>vchatBus。 聊天室事件总线，协议为key，实现为value，储存在单例中，统一分发</li>
<li>优先级队列。 通过堆实现</li>
</ul>
<ol start="2">
<li>业务模块儿</li>
</ol>
<ul>
<li>重构Timer，统一调度</li>
<li>实现优先级view，以此重构banner区，房间广播，礼物动效等队列管理</li>
<li>重构IM消息分发，RTC事件回调，基于vchatbus组件</li>
<li>整理视图层级，functionview，popbackgroudview. 管理各种不同层级的视图，和弹窗</li>
</ul>
<ol start="3">
<li>媒体报警日志及问题查询</li>
</ol>
<ul>
<li>媒体查询<ol>
<li>媒体中台</li>
<li>kibanna日志</li>
<li>IM日志捞取</li>
<li>接口回调</li>
<li>hubble警告</li>
</ol>
</li>
<li>crash等问题<ol>
<li>公司内部crash后台分析</li>
<li>MDLog的kibana日志</li>
<li>IM日志捞取</li>
<li>接口查询</li>
</ol>
</li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>sdwebimage的问题， 老的下载还在排队，新的下载取消了所有的回调</li>
<li>init方法的问题arc下，过度release</li>
</ul>
<h2 id="书"><a href="#书" class="headerlink" title="书"></a>书</h2><ul>
<li>程序员的自我修养</li>
<li>多线程与内存管理</li>
<li>深入理解osx/ios操作系统</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jack Wang"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Jack Wang</p>
  <div class="site-description" itemprop="description">书山有路勤为径，学海无涯苦作舟！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">71</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">78</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29yZ3Mvd2FuZ2tlamllL3JlcG9zaXRvcmllcw==" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;orgs&#x2F;wangkejie&#x2F;repositories"><i class="github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOjcyNzg4MTk0NUBxcS5jb20=" title="E-Mail → mailto:727881945@qq.com"><i class="envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbg==">京ICP备16036665号-2 </span>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jack Wang</span>
</div>

        


  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1277804316&web_id=1277804316"></script>
  </div>






      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://wangkejie.com/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'S7tR3Qqx6JSg8P5ChLXjLWt8-gzGzoHsz',
      appKey     : 'hHRdJzqrf8zU1xQElb7km39u',
      placeholder: "上面也可以填入联系方式，感谢您宝贵的建议~",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
